<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  
  <style>
    /* --- GLOBAL STYLE (SAMA DENGAN INBOUND) --- */
    :root { --primary: #2563eb; --bg-body: #f8f9fa; --card-bg: #ffffff; --border-color: #e9ecef; --text-label: #64748b; --text-dark: #1e293b; --error-bg: #fef2f2; --error-border: #fca5a5; --error-text: #b91c1c; }
    body { background-color: var(--bg-body); font-family: 'Inter', sans-serif; color: var(--text-dark); font-size: 14px; }
    input[type="text"], textarea, .form-control { text-transform: uppercase; }
    .content { margin-left: 250px; padding: 25px 40px; transition: all 0.3s; }
    
    /* HEADER STYLE */
    .odoo-header { background: white; border-bottom: 1px solid var(--border-color); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 99; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02); margin: -25px -40px 30px -40px; }
    .status-badge { font-size: 13px; font-weight: 700; padding: 8px 16px; border-radius: 6px; }
    .status-draft { background: #fef3c7; color: #b45309; border: 1px solid #fcd34d; } /* Kuning untuk Outbound Draft */
    .status-done { background: #dcfce7; color: #166534; border: 1px solid #86efac; display: none; }
    
    /* CARD STYLE */
    .card-clean { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 30px; }
    .card-header-clean { padding: 15px 25px; border-bottom: 1px solid var(--border-color); font-weight: 700; color: var(--primary); text-transform: uppercase; font-size: 12px; background: #fff; border-radius: 12px 12px 0 0; letter-spacing: 0.5px; display: flex; justify-content: space-between; align-items: center; }
    .card-body-clean { padding: 30px; }
    
    /* FORM STYLE */
    .form-label { font-size: 11px; font-weight: 600; color: var(--text-label); text-transform: uppercase; margin-bottom: 6px; }
    .form-control, .form-select { border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px 15px; font-size: 14px; }
    .form-control:focus, .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15); }
    
    /* MODAL STYLE */
    .modal-content { border: none; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
    .modal-header { padding: 20px 30px; border-bottom: 1px solid #f1f5f9; }
    .modal-section-search { padding: 25px 30px 10px 30px; background: #fff; }
    
    /* PRODUCT DISPLAY CARD */
    .product-display-card { background: #eff6ff; border: 1px solid #dbeafe; border-radius: 10px; padding: 15px 20px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
    .product-title { font-size: 16px; font-weight: 700; color: #1e3a8a; margin-bottom: 2px; }
    .product-brand { font-size: 12px; color: #60a5fa; font-weight: 600; text-transform: uppercase; }
    .product-notes { font-size: 11px; color: #64748b; font-weight: 600; margin-top: 4px; font-style: italic; display: block; }
    .hidden-logic-input { position: absolute; opacity: 0; pointer-events: none; }
    
    /* TABLES */
    .table-custom thead th { background: #f8f9fa; color: #64748b; font-size: 11px; font-weight: 700; padding: 15px; border-bottom: 2px solid #e2e8f0; }
    .table-custom tbody td { padding: 15px; vertical-align: middle; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
    .btn-add-big { background: #fff; border: 1px dashed #cbd5e1; color: var(--primary); width: 100%; padding: 15px; border-radius: 8px; font-weight: 600; transition: 0.2s; }
    .btn-add-big:hover { background: #eff6ff; border-color: var(--primary); }
    .btn-primary-custom { background: var(--primary); border: none; padding: 12px 30px; font-weight: 600; border-radius: 8px; color: white; transition: 0.2s; }
    .btn-primary-custom:hover { background: #1d4ed8; transform: translateY(-1px); }
    .btn-primary-custom:disabled { background: #93c5fd; cursor: not-allowed; }

    /* PICKING PROGRESS */
    .progress-picking { height: 6px; border-radius: 3px; background-color: #e2e8f0; margin-top: 5px; overflow: hidden; }
    .progress-bar-picking { height: 100%; background-color: #f59e0b; transition: width 0.3s; }
    .progress-complete { background-color: #10b981; }
    
    /* PICKING TABLE IN MODAL */
    .picking-table th { font-size: 11px; text-transform: uppercase; background: #f1f5f9; padding: 10px; }
    .picking-table td { padding: 10px; font-size: 13px; vertical-align: middle; }
    .picking-input { width: 80px; text-align: center; font-weight: 700; color: var(--primary); border: 1px solid #cbd5e1; border-radius: 4px; padding: 4px; }
    
    .btn-action-group { display: flex; flex-direction: column; gap: 4px; align-items: flex-end; }
  </style>
</head>
<body>

  <?!= include('Sidebar', {scriptUrl: scriptUrl, page: page}); ?>

  <div class="content">
    <div class="odoo-header">
      <div class="d-flex align-items-center gap-3">
        <span id="status-draft" class="status-badge status-draft">OUTBOUND DRAFT</span>
        <span id="status-done" class="status-badge status-done">
            <i class="material-icons align-middle me-1" style="font-size:16px;">check_circle</i> 
            <span id="final-trx-id">OUT-XXXX</span>
        </span>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-light border fw-bold text-muted btn-sm px-3" onclick="resetAll()">RESET</button>
        <button id="btn-validate" class="btn-primary-custom d-flex align-items-center py-2 px-4" onclick="validateOutbound()">
          <i class="material-icons me-2" style="font-size:18px;">local_shipping</i> PROSES OUTBOUND
        </button>
      </div>
    </div>

    <div class="card-clean">
      <div class="card-header-clean"><span class="d-flex align-items-center"><i class="material-icons align-middle me-2">description</i> Informasi Pengeluaran</span></div>
      <div class="card-body-clean">
        <div class="row g-4">
          <div class="col-md-3">
            <label class="form-label">Tanggal Outbound <span class="text-danger">*</span></label>
            <input type="date" class="form-control" id="h-tanggal">
          </div>
          <div class="col-md-3">
            <label class="form-label text-primary">No. Dokumen / SO <span class="text-danger">*</span></label>
            <input type="text" class="form-control fw-bold bg-light" id="h-docNo" placeholder="SO-202X-XXXX">
          </div>
          <div class="col-md-3">
            <label class="form-label">Customer / Tujuan <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="h-customer" placeholder="Nama Customer / Cabang">
          </div>
          <div class="col-md-3">
            <label class="form-label">Catatan Outbound</label>
            <textarea class="form-control" id="h-notes" rows="1" placeholder="Keterangan tambahan..."></textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="card-clean">
      <div class="card-header-clean">
        <span class="d-flex align-items-center"><i class="material-icons align-middle me-2">shopping_cart</i> Daftar Barang (Permintaan)</span>
        <div><span class="badge bg-secondary ms-2 align-self-center" id="total-items">0 Item</span></div>
      </div>

      <div class="card-body-clean p-0">
        <div class="table-responsive">
          <table class="table table-custom table-hover mb-0">
            <thead>
              <tr>
                <th width="5%" class="text-center">#</th>
                <th width="35%">Nama Barang / SKU</th>
                <th width="15%" class="text-center">Qty Request</th>
                <th width="15%" class="text-center">Qty Picked</th>
                <th width="20%">Detail Picking (Batch/Loc)</th>
                <th width="10%" class="text-end">Aksi</th>
              </tr>
            </thead>
            <tbody id="cart-body">
              <tr><td colspan="6" class="p-5 text-center text-muted">Belum ada barang yang diminta.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="p-4 bg-light border-top">
           <button class="btn-add-big" onclick="openInputModal()">
             <i class="material-icons align-middle me-2">add_circle_outline</i> TAMBAH SKU
           </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalInput" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold text-dark"><i class="material-icons align-middle me-2 text-primary">add_box</i> Input Permintaan Barang</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        
        <div class="modal-section-search">
            <label class="form-label">Cari Barang (SKU / Nama)</label>
            <div class="input-group mb-3">
              <span class="input-group-text bg-white"><i class="material-icons text-muted">search</i></span>
              <input class="form-control form-control-lg" list="listProduk" id="i-kode" placeholder="Ketik Kode / Nama Barang..." onchange="isiOtomatis()" autocomplete="off">
              <button class="btn btn-dark px-4" onclick="bukaScanner()"><i class="material-icons align-middle me-2">qr_code</i> SCAN</button>
            </div>
            <datalist id="listProduk"></datalist>
            
            <input type="hidden" id="i-kode-asli">
            <input type="text" id="i-nama" class="hidden-logic-input">
            <input type="text" id="i-brand" class="hidden-logic-input">
            <input type="text" id="i-notes-master" class="hidden-logic-input">

            <div class="product-display-card">
               <div>
                  <div class="product-title" id="disp-nama">- Pilih Barang Dulu -</div>
                  <div class="product-brand" id="disp-brand">BRAND: -</div>
                  <div class="product-notes" id="disp-notes">NOTES: -</div>
               </div>
               <div class="text-end"><i class="material-icons text-primary opacity-25" style="font-size: 32px">verified</i></div>
            </div>
        </div>

        <div class="modal-body p-4 pt-0">
            <div class="row g-3">
               <div class="col-md-6 offset-md-3">
                  <label class="form-label text-primary fw-bold text-center w-100" style="font-size:14px;">QTY REQUEST (BUTUH)</label>
                  <input type="number" class="form-control form-control-lg qty-input border-primary" id="i-qty-req" placeholder="0">
                  <div class="form-text text-center">Masukkan jumlah total yang dibutuhkan.</div>
               </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                <button type="button" class="btn btn-light text-muted fw-bold px-4" data-bs-dismiss="modal">BATAL</button>
                <button type="button" class="btn-primary-custom px-5" onclick="addToCart()">
                  <i class="material-icons align-middle me-2">playlist_add</i> MASUKKAN KE DAFTAR
                </button>
            </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalPicking" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title fw-bold text-dark"><i class="material-icons align-middle me-2 text-warning">move_to_inbox</i> Picking Barang</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
           <div class="p-3 bg-white border-bottom">
              <div class="d-flex justify-content-between">
                 <div>
                    <div class="fw-bold fs-5" id="p-sku">SKU-001</div>
                    <div class="text-muted" id="p-nama">Nama Produk</div>
                 </div>
                 <div class="text-end">
                    <div class="small text-muted text-uppercase">Request</div>
                    <div class="fw-bold fs-4 text-primary" id="p-req-qty">0</div>
                 </div>
              </div>
           </div>

           <div class="table-responsive">
              <table class="table table-sm table-hover mb-0 picking-table">
                 <thead>
                    <tr>
                       <th>Lokasi</th>
                       <th>Batch / Exp</th>
                       <th>Attributes</th>
                       <th class="text-center">Stock</th>
                       <th class="text-center" width="120px">Pick Qty</th>
                    </tr>
                 </thead>
                 <tbody id="picking-body">
                    <tr><td colspan="5" class="text-center py-4">Memuat data stok...</td></tr>
                 </tbody>
                 <tfoot class="table-light">
                    <tr>
                       <td colspan="3" class="text-end fw-bold align-middle">TOTAL PICKED:</td>
                       <td colspan="2" class="text-center align-middle">
                          <span id="p-total-picked" class="fs-5 fw-bold text-danger">0</span>
                          <span class="text-muted mx-1">/</span>
                          <span id="p-total-target" class="fw-bold">0</span>
                       </td>
                    </tr>
                 </tfoot>
              </table>
           </div>
        </div>
        <div class="modal-footer justify-content-between">
           <span id="p-msg" class="small text-danger fw-bold"></span>
           <button type="button" class="btn-primary-custom" id="btn-save-pick" onclick="savePicking()">
              <i class="material-icons align-middle me-2">check</i> SIMPAN PICKING
           </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalScanner" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content bg-black">
        <div class="modal-body p-0"><div id="reader"></div></div>
        <div class="modal-footer border-0 p-2 justify-content-center bg-black"><button class="btn btn-sm btn-outline-light w-100" onclick="stopScanner()">Tutup Kamera</button></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ============================================================
    // A. SETUP & VARIABLE
    // ============================================================
    let cart = [];          // Format: { sku, nama, brand, notes, reqQty, pickedQty, pickDetails: [] }
    let masterProduk = [];
    let modalInputBS, modalPickingBS, modalScannerBS;
    let html5QrcodeScanner = null;
    let editingIndex = -1;  // Index cart yang sedang diedit/picking

    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById('h-tanggal').valueAsDate = new Date();
      
      modalInputBS = new bootstrap.Modal(document.getElementById('modalInput'));
      modalPickingBS = new bootstrap.Modal(document.getElementById('modalPicking'));
      modalScannerBS = new bootstrap.Modal(document.getElementById('modalScanner'));
      
      loadFromStorage();
      
      // Load Master Produk
      google.script.run.withSuccessHandler(d => {
        masterProduk = d;
        let list = document.getElementById("listProduk");
        list.innerHTML = "";
        d.forEach(r => { let opt = document.createElement("option"); opt.value = r[0]; opt.label = r[1]; list.appendChild(opt); });
      }).getMasterData();
    });

    // ============================================================
    // B. ADD SKU TO CART (REQUEST)
    // ============================================================
    
    function isiOtomatis() {
      const val = document.getElementById("i-kode").value.trim().toUpperCase(); 
      const found = masterProduk.find(r => String(r[0]).toUpperCase() === val || String(r[1]).toUpperCase() === val);
      if (found) { 
          document.getElementById("i-kode").value = found[0]; 
          document.getElementById("i-kode-asli").value = found[0]; 
          document.getElementById("i-nama").value = found[1]; 
          document.getElementById("i-brand").value = found[2]; 
          document.getElementById("disp-nama").innerText = found[1]; 
          document.getElementById("disp-brand").innerText = "BRAND: " + found[2];
          
          let n = found[3] || "-";
          document.getElementById("disp-notes").innerText = "NOTES: " + n;
          document.getElementById("i-notes-master").value = n;

          document.getElementById("i-qty-req").focus(); 
      }
    }

    function addToCart() {
       let sku = document.getElementById('i-kode-asli').value || document.getElementById('i-kode').value;
       let req = parseInt(document.getElementById('i-qty-req').value);

       if(!sku || !req || req <= 0) {
          Swal.fire("Data Kurang", "Pastikan Produk dipilih dan Qty Request > 0", "warning"); return;
       }

       // Cek duplikat SKU
       let exist = cart.find(x => x.sku === sku);
       if(exist) {
          Swal.fire("Duplicate", "SKU ini sudah ada di daftar. Edit qty di tabel jika ingin mengubah.", "warning"); return;
       }

       let item = {
          sku: sku,
          nama: document.getElementById('i-nama').value,
          brand: document.getElementById('i-brand').value,
          notes: document.getElementById('i-notes-master').value,
          reqQty: req,
          pickedQty: 0,
          pickDetails: [] // Array of { batch, location, exp, qty, sticker, size, cover }
       };

       cart.push(item);
       saveToStorage();
       renderCart();
       
       // Reset Form
       document.getElementById('i-kode').value = "";
       document.getElementById('i-kode-asli').value = "";
       document.getElementById('i-nama').value = "";
       document.getElementById('disp-nama').innerText = "- Pilih Barang -";
       document.getElementById('i-qty-req').value = "";
       
       modalInputBS.hide();
    }

    // ============================================================
    // C. PICKING LOGIC (CORE OUTBOUND)
    // ============================================================

    // 1. Buka Modal & Load Stock Available
    function openPickingModal(index) {
       editingIndex = index;
       let item = cart[index];
       
       // UI Header
       document.getElementById('p-sku').innerText = item.sku;
       document.getElementById('p-nama').innerText = item.nama;
       document.getElementById('p-req-qty').innerText = item.reqQty;
       document.getElementById('p-total-target').innerText = item.reqQty;
       
       // Tampilkan Loading
       let tbody = document.getElementById('picking-body');
       tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary"></div><div class="mt-2 small">Mencari stok available...</div></td></tr>`;
       
       modalPickingBS.show();

       // Panggil Backend untuk cari stok SKU ini
       google.script.run.withSuccessHandler(stockList => {
          renderPickingTable(stockList, item);
       }).getAvailableStockForPicking(item.sku);
    }

    // 2. Render Tabel Picking
    function renderPickingTable(stockList, cartItem) {
       let tbody = document.getElementById('picking-body');
       tbody.innerHTML = "";

       if(!stockList || stockList.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-danger fw-bold">Stok Kosong / Tidak Tersedia!</td></tr>`;
          updatePickingTotal();
          return;
       }

       stockList.forEach((stk, idx) => {
          // Cek apakah batch ini sudah ada di pickDetails cartItem
          let alreadyPicked = 0;
          let pickedRec = cartItem.pickDetails.find(p => 
             p.batch === stk.batch && p.lokasi === stk.lokasi && p.exp === stk.exp
          );
          if(pickedRec) alreadyPicked = pickedRec.qty;

          let tr = document.createElement('tr');
          
          // Format Attribute
          let attr = [];
          if(stk.sticker && stk.sticker != "-") attr.push(`ST:${stk.sticker}`);
          if(stk.size && stk.size != "-") attr.push(`SZ:${stk.size}`);
          if(stk.cover && stk.cover != "-") attr.push(`CV:${stk.cover}`);
          
          tr.innerHTML = `
             <td>
                <div class="fw-bold text-dark">${stk.lokasi}</div>
                <div class="small text-muted badge bg-light text-dark border">${stk.typeLoc}</div>
             </td>
             <td>
                <div class="font-monospace small fw-bold">${stk.batch}</div>
                <div class="small text-muted">${stk.exp || '-'}</div>
             </td>
             <td class="small text-muted">${attr.join(' ') || '-'}</td>
             <td class="text-center fw-bold fs-6">${stk.qty}</td>
             <td class="text-center">
                <input type="number" class="picking-input" 
                   data-max="${stk.qty}" 
                   data-batch="${stk.batch}" 
                   data-loc="${stk.lokasi}" 
                   data-exp="${stk.exp}"
                   data-sticker="${stk.sticker}"
                   data-size="${stk.size}"
                   data-cover="${stk.cover}"
                   data-typeloc="${stk.typeLoc}"
                   value="${alreadyPicked}" 
                   min="0" max="${stk.qty}" 
                   oninput="updatePickingTotal()"
                   onfocus="this.select()">
             </td>
          `;
          tbody.appendChild(tr);
       });
       
       updatePickingTotal();
    }

    // 3. Hitung Total Real-time
    function updatePickingTotal() {
       let inputs = document.querySelectorAll('.picking-input');
       let total = 0;
       
       inputs.forEach(inp => {
          let val = parseInt(inp.value) || 0;
          let max = parseInt(inp.getAttribute('data-max'));
          
          if(val > max) { val = max; inp.value = max; } // Prevent over pick
          if(val < 0) { val = 0; inp.value = 0; }
          
          total += val;
       });

       let req = parseInt(document.getElementById('p-total-target').innerText);
       let dispTotal = document.getElementById('p-total-picked');
       let msg = document.getElementById('p-msg');
       let btn = document.getElementById('btn-save-pick');

       dispTotal.innerText = total;
       
       // Visual Feedback
       if(total === req) {
          dispTotal.className = "fs-5 fw-bold text-success";
          msg.innerText = "OK. Jumlah sesuai.";
          msg.className = "small text-success fw-bold";
          btn.disabled = false;
       } else if (total > req) {
          dispTotal.className = "fs-5 fw-bold text-danger";
          msg.innerText = "OVER! Melebihi request.";
          msg.className = "small text-danger fw-bold";
          // btn.disabled = true; // Optional: boleh over pick? biasanya tidak.
       } else {
          dispTotal.className = "fs-5 fw-bold text-warning";
          msg.innerText = "Kurang dari request.";
          msg.className = "small text-warning fw-bold";
          btn.disabled = false; // Boleh partial pick
       }
    }

    // 4. Save Picking ke Cart
    function savePicking() {
       let inputs = document.querySelectorAll('.picking-input');
       let newDetails = [];
       let totalPicked = 0;

       inputs.forEach(inp => {
          let qty = parseInt(inp.value) || 0;
          if(qty > 0) {
             newDetails.push({
                batch: inp.getAttribute('data-batch'),
                lokasi: inp.getAttribute('data-loc'),
                exp: inp.getAttribute('data-exp'),
                typeLokasi: inp.getAttribute('data-typeloc'),
                typeSticker: inp.getAttribute('data-sticker'),
                size: inp.getAttribute('data-size'),
                sizeCover: inp.getAttribute('data-cover'),
                qty: qty
             });
             totalPicked += qty;
          }
       });

       // Update Cart Data
       if(editingIndex >= 0) {
          cart[editingIndex].pickDetails = newDetails;
          cart[editingIndex].pickedQty = totalPicked;
       }

       saveToStorage();
       renderCart();
       modalPickingBS.hide();
       validateOutboundButtons(); // Cek apakah tombol final bisa aktif
    }

    // ============================================================
    // D. RENDER & ACTIONS
    // ============================================================

    function renderCart() {
       let tbody = document.getElementById('cart-body'); tbody.innerHTML = "";
       if(cart.length === 0) { tbody.innerHTML = `<tr><td colspan="6" class="p-5 text-center text-muted">Belum ada barang. Klik Tambah SKU.</td></tr>`; document.getElementById('total-items').innerText = "0 Item"; return; }
       
       cart.forEach((item, index) => {
          // Status Warna Picking
          let pickStatusClass = "text-danger";
          let progressPercent = 0;
          if(item.pickedQty >= item.reqQty) { pickStatusClass = "text-success"; progressPercent = 100; }
          else if(item.pickedQty > 0) { pickStatusClass = "text-warning"; progressPercent = (item.pickedQty/item.reqQty)*100; }

          // Notes Master
          let masterNote = item.notes && item.notes !== "-" ? `<div class="small text-muted fst-italic mt-1"><i class="material-icons" style="font-size:10px">info</i> ${item.notes}</div>` : "";

          // Detail Picking String
          let pickInfo = "";
          if(item.pickDetails.length > 0) {
             pickInfo = `<div class="d-flex flex-column gap-1">`;
             item.pickDetails.forEach(d => {
                pickInfo += `<span class="badge bg-light text-dark border d-flex justify-content-between" style="font-size:11px;">
                   <span>${d.lokasi} [${d.batch}]</span> <strong>${d.qty}</strong>
                </span>`;
             });
             pickInfo += `</div>`;
          } else {
             pickInfo = `<span class="text-muted small fst-italic">Belum picking</span>`;
          }

          let tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="text-center fw-bold text-muted">${index + 1}</td>
            <td>
                <div class="fw-bold text-dark">${item.nama}</div>
                <div class="small text-muted badge bg-light text-dark border">${item.sku}</div>
                ${masterNote}
            </td>
            <td class="text-center align-middle">
               <span class="fs-6 fw-bold text-dark">${item.reqQty}</span>
            </td>
            <td class="text-center align-middle">
               <span class="fs-6 fw-bold ${pickStatusClass}">${item.pickedQty}</span>
               <div class="progress-picking"><div class="progress-bar-picking ${item.pickedQty>=item.reqQty?'progress-complete':''}" style="width:${progressPercent}%"></div></div>
            </td>
            <td class="align-top pt-3">${pickInfo}</td>
            <td class="text-end align-middle">
               <div class="btn-action-group">
                  <button class="btn btn-sm btn-primary text-white" onclick="openPickingModal(${index})">
                     <i class="material-icons" style="font-size:16px">move_to_inbox</i> PICK
                  </button>
                  <button class="btn btn-sm btn-light text-danger border" onclick="hapusCart(${index})">
                     <i class="material-icons" style="font-size:16px">delete</i>
                  </button>
               </div>
            </td>
          `;
          tbody.appendChild(tr);
       });
       document.getElementById('total-items').innerText = `${cart.length} Item`;
       validateOutboundButtons();
    }

    function hapusCart(index) { cart.splice(index, 1); saveToStorage(); renderCart(); }
    
    function resetAll() { if(cart.length>0 && !confirm("Reset Form?")) return; localStorage.removeItem("wms_outbound_cart"); location.reload(); }
    
    function saveToStorage() { localStorage.setItem("wms_outbound_cart", JSON.stringify(cart)); }
    
    function loadFromStorage() { 
       let s = localStorage.getItem("wms_outbound_cart"); 
       if(s) { cart = JSON.parse(s); renderCart(); } 
    }

    // ============================================================
    // E. VALIDATION & SAVE TRANSACTION
    // ============================================================

    function validateOutboundButtons() {
       let btn = document.getElementById('btn-validate');
       if(cart.length === 0) { btn.disabled = true; return; }
       
       // Cek apakah SEMUA item sudah full picked
       let allComplete = cart.every(i => i.pickedQty >= i.reqQty);
       
       if(allComplete) {
          btn.disabled = false;
          btn.classList.remove('btn-secondary');
          btn.classList.add('btn-primary-custom');
       } else {
          btn.disabled = true; // Disabled sampai semua picked
       }
    }

    function validateOutbound() {
       let header = {
          tanggal: document.getElementById('h-tanggal').value,
          docNo: document.getElementById('h-docNo').value.toUpperCase(),
          customer: document.getElementById('h-customer').value.toUpperCase(),
          notes: document.getElementById('h-notes').value.toUpperCase()
       };

       if(!header.tanggal || !header.docNo || !header.customer) {
          Swal.fire("Header Kurang", "Tanggal, No Dokumen, dan Customer Wajib Diisi!", "error"); return;
       }

       Swal.fire({ 
          title: 'Proses Outbound?', 
          text: `Mengeluarkan ${cart.length} SKU dari stok?`, 
          icon: 'warning', 
          showCancelButton: true, 
          confirmButtonText: 'YA, PROSES', 
          confirmButtonColor: '#2563eb' 
       }).then((result) => { 
          if (result.isConfirmed) { 
             let btn = document.getElementById('btn-validate'); 
             btn.innerHTML = "LOADING..."; btn.disabled = true; 
             
             google.script.run.withSuccessHandler((res) => { 
                if(res.success) { 
                   Swal.fire("Sukses!", res.message, "success"); 
                   document.getElementById('status-draft').style.display = 'none'; 
                   document.getElementById('status-done').style.display = 'inline-block'; 
                   document.getElementById('final-trx-id').innerText = res.trxId; 
                   
                   // Disable Form
                   document.querySelectorAll('input, button, textarea').forEach(e => e.disabled = true); 
                   document.querySelector('.btn-close').disabled = false; // Kecuali close modal
                   
                   cart = []; saveToStorage(); 
                } else { 
                   Swal.fire("Gagal", res.message, "error"); 
                   btn.innerHTML = '<i class="material-icons me-2" style="font-size:18px;">local_shipping</i> PROSES OUTBOUND'; 
                   btn.disabled = false; 
                } 
             }).processOutboundTransaction(header, cart); 
          } 
       });
    }

    // ============================================================
    // F. SCANNER & HELPER
    // ============================================================
    function openInputModal() {
       document.getElementById('i-qty-req').value = "";
       // Reset search
       document.getElementById('i-kode').value = "";
       document.getElementById('i-kode-asli').value = "";
       document.getElementById('disp-nama').innerText = "- Pilih Barang -";
       modalInputBS.show();
       setTimeout(() => document.getElementById('i-kode').focus(), 500);
    }

    function bukaScanner() { modalScannerBS.show(); setTimeout(() => { if (!html5QrcodeScanner) html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 20, qrbox: 200 }, false); html5QrcodeScanner.render(onScanSuccess); }, 500); }
    function onScanSuccess(txt) { if (html5QrcodeScanner) html5QrcodeScanner.pause(); document.getElementById("i-kode").value = txt; isiOtomatis(); modalScannerBS.hide(); stopScanner(); }
    function stopScanner() { if(html5QrcodeScanner) { html5QrcodeScanner.clear(); } modalScannerBS.hide(); }
  </script>
</body>
</html>
