<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  
  <style>
    /* --- GLOBAL STYLE --- */
    :root { --primary: #2563eb; --bg-body: #f8f9fa; --card-bg: #ffffff; --border-color: #e9ecef; --text-label: #64748b; --text-dark: #1e293b; --error-bg: #fef2f2; --error-border: #fca5a5; --error-text: #b91c1c; }
    body { background-color: var(--bg-body); font-family: 'Inter', sans-serif; color: var(--text-dark); font-size: 14px; }
    input[type="text"], textarea, .form-control { text-transform: uppercase; }
    .content { margin-left: 250px; padding: 25px 40px; transition: all 0.3s; }
    
    /* HEADER STYLE */
    .odoo-header { background: white; border-bottom: 1px solid var(--border-color); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 99; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02); margin: -25px -40px 30px -40px; }
    .status-badge { font-size: 13px; font-weight: 700; padding: 8px 16px; border-radius: 6px; }
    .status-draft { background: #fef3c7; color: #b45309; border: 1px solid #fcd34d; } 
    .status-done { background: #dcfce7; color: #166534; border: 1px solid #86efac; display: none; }
    
    /* CARD STYLE */
    .card-clean { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 30px; }
    .card-header-clean { padding: 15px 25px; border-bottom: 1px solid var(--border-color); font-weight: 700; color: var(--primary); text-transform: uppercase; font-size: 12px; background: #fff; border-radius: 12px 12px 0 0; letter-spacing: 0.5px; display: flex; justify-content: space-between; align-items: center; }
    .card-body-clean { padding: 30px; }
    
    /* FORM STYLE */
    .form-label { font-size: 11px; font-weight: 600; color: var(--text-label); text-transform: uppercase; margin-bottom: 6px; }
    .form-control, .form-select { border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px 15px; font-size: 14px; }
    .form-control:focus, .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15); }
    
    /* MODAL STYLE */
    .modal-content { border: none; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
    .modal-header { padding: 20px 30px; border-bottom: 1px solid #f1f5f9; }
    .modal-section-search { padding: 25px 30px 10px 30px; background: #fff; }
    
    /* TABLES */
    .table-custom thead th { background: #f8f9fa; color: #64748b; font-size: 11px; font-weight: 700; padding: 15px; border-bottom: 2px solid #e2e8f0; }
    .table-custom tbody td { padding: 15px; vertical-align: middle; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
    .btn-add-big { background: #fff; border: 1px dashed #cbd5e1; color: var(--primary); width: 100%; padding: 15px; border-radius: 8px; font-weight: 600; transition: 0.2s; }
    .btn-add-big:hover { background: #eff6ff; border-color: var(--primary); }
    .btn-primary-custom { background: var(--primary); border: none; padding: 12px 30px; font-weight: 600; border-radius: 8px; color: white; transition: 0.2s; }
    .btn-primary-custom:hover { background: #1d4ed8; transform: translateY(-1px); }
    .btn-primary-custom:disabled { background: #93c5fd; cursor: not-allowed; }

    /* PICKING PROGRESS */
    .progress-picking { height: 6px; border-radius: 3px; background-color: #e2e8f0; margin-top: 5px; overflow: hidden; }
    .progress-bar-picking { height: 100%; background-color: #f59e0b; transition: width 0.3s; }
    .progress-complete { background-color: #10b981; }
    
    /* PICKING TABLE IN MODAL */
    .picking-table th { font-size: 11px; text-transform: uppercase; background: #f1f5f9; padding: 10px; }
    .picking-table td { padding: 10px; font-size: 13px; vertical-align: middle; }
    .picking-input { width: 80px; text-align: center; font-weight: 700; color: var(--primary); border: 1px solid #cbd5e1; border-radius: 4px; padding: 4px; }
    
    .btn-action-group { display: flex; flex-direction: column; gap: 4px; align-items: flex-end; }
  </style>
</head>
<body>

  <?!= include('Sidebar', {scriptUrl: scriptUrl, page: page}); ?>

  <div class="content">
    <div class="odoo-header">
      <div class="d-flex align-items-center gap-3">
        <span id="status-draft" class="status-badge status-draft">OUTBOUND DRAFT</span>
        <span id="status-done" class="status-badge status-done">
            <i class="material-icons align-middle me-1" style="font-size:16px;">check_circle</i> 
            <span id="final-trx-id">OUT-XXXX</span>
        </span>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-light border fw-bold text-muted btn-sm px-3" onclick="resetAll()">RESET</button>
        <button id="btn-validate" class="btn-primary-custom d-flex align-items-center py-2 px-4" onclick="validateOutbound()" disabled>
          <i class="material-icons me-2" style="font-size:18px;">local_shipping</i> PROSES OUTBOUND
        </button>
      </div>
    </div>

    <div class="card-clean">
      <div class="card-header-clean"><span class="d-flex align-items-center"><i class="material-icons align-middle me-2">description</i> Informasi Pengeluaran</span></div>
      <div class="card-body-clean">
        <div class="row g-4">
          <div class="col-md-3">
            <label class="form-label">Tanggal Outbound <span class="text-danger">*</span></label>
            <input type="date" class="form-control" id="h-tanggal">
          </div>
          <div class="col-md-3">
            <label class="form-label text-primary">No. Dokumen / SO <span class="text-danger">*</span></label>
            <input type="text" class="form-control fw-bold bg-light" id="h-docNo" placeholder="SO-202X-XXXX">
          </div>
          <div class="col-md-3">
            <label class="form-label">Customer / Tujuan <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="h-customer" placeholder="Nama Customer / Cabang">
          </div>
          <div class="col-md-3">
            <label class="form-label">Catatan Outbound</label>
            <textarea class="form-control" id="h-notes" rows="1" placeholder="Keterangan tambahan..."></textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="card-clean">
      <div class="card-header-clean">
        <span class="d-flex align-items-center"><i class="material-icons align-middle me-2">shopping_cart</i> Daftar Barang (Permintaan)</span>
        <div><span class="badge bg-secondary ms-2 align-self-center" id="total-items">0 Item</span></div>
      </div>

      <div class="card-body-clean p-0">
        <div class="table-responsive">
          <table class="table table-custom table-hover mb-0">
            <thead>
              <tr>
                <th width="5%" class="text-center">#</th>
                <th width="35%">Nama Barang / SKU</th>
                <th width="15%" class="text-center">Qty Request</th>
                <th width="15%" class="text-center">Qty Picked</th>
                <th width="20%">Detail Picking (Batch/Loc)</th>
                <th width="10%" class="text-end">Aksi</th>
              </tr>
            </thead>
            <tbody id="cart-body">
              <tr><td colspan="6" class="p-5 text-center text-muted">Belum ada barang yang diminta.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="p-4 bg-light border-top">
           <button class="btn-add-big" onclick="openInputModal()">
             <i class="material-icons align-middle me-2">add_circle_outline</i> TAMBAH SKU
           </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalInput" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold text-dark"><i class="material-icons align-middle me-2 text-primary">add_box</i> Input Permintaan Barang</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        
        <div class="modal-section-search">
            <label class="form-label">Cari Barang (SKU / Nama)</label>
            <div class="input-group mb-3">
              <span class="input-group-text bg-white"><i class="material-icons text-muted">search</i></span>
              <input class="form-control form-control-lg" list="listProduk" id="i-kode" placeholder="Ketik Kode / Nama Barang..." onchange="isiOtomatis()" autocomplete="off">
              <button class="btn btn-dark px-4" onclick="bukaScanner()"><i class="material-icons align-middle me-2">qr_code</i> SCAN</button>
            </div>
            <datalist id="listProduk"></datalist>
            
            <input type="hidden" id="i-kode-asli">
            <input type="hidden" id="i-nama">
            <input type="hidden" id="i-brand">
            <input type="hidden" id="i-notes-master">

            <div class="p-3 bg-light border rounded d-flex justify-content-between align-items-center">
               <div>
                  <div class="fw-bold text-primary" id="disp-nama" style="font-size:16px">- Pilih Barang Dulu -</div>
                  <div class="text-muted small fw-bold" id="disp-brand">BRAND: -</div>
                  <div class="text-muted small fst-italic mt-1" id="disp-notes">NOTES: -</div>
               </div>
               <i class="material-icons text-primary opacity-25" style="font-size: 32px">verified</i>
            </div>
        </div>

        <div class="modal-body p-4 pt-3">
            <div class="row g-3">
               <div class="col-md-6 offset-md-3">
                  <label class="form-label text-primary fw-bold text-center w-100" style="font-size:14px;">QTY REQUEST (BUTUH)</label>
                  <input type="number" class="form-control form-control-lg text-center fw-bold text-primary border-primary" id="i-qty-req" placeholder="0" style="font-size:24px;">
                  <div class="form-text text-center">Masukkan jumlah total yang dibutuhkan.</div>
               </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                <button type="button" class="btn btn-light text-muted fw-bold px-4" data-bs-dismiss="modal">BATAL</button>
                <button type="button" class="btn-primary-custom px-5" onclick="addToCart()">
                  <i class="material-icons align-middle me-2">playlist_add</i> MASUKKAN KE DAFTAR
                </button>
            </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalPicking" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title fw-bold text-dark"><i class="material-icons align-middle me-2 text-warning">move_to_inbox</i> Picking Barang</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
           <div class="p-3 bg-white border-bottom sticky-top">
              <div class="d-flex justify-content-between align-items-center">
                 <div>
                    <div class="fw-bold fs-5" id="p-sku">SKU-001</div>
                    <div class="text-muted small" id="p-nama">Nama Produk</div>
                 </div>
                 <div class="text-end">
                    <div class="small text-muted text-uppercase fw-bold">Target Request</div>
                    <div class="fw-bold fs-3 text-primary" id="p-req-qty">0</div>
                 </div>
              </div>
           </div>

           <div class="table-responsive">
              <table class="table table-sm table-hover mb-0 picking-table">
                 <thead>
                    <tr>
                       <th>Lokasi</th>
                       <th>Batch / Expired</th>
                       <th>Atribut</th>
                       <th class="text-center">Stok</th>
                       <th class="text-center" width="120px">Pick Qty</th>
                    </tr>
                 </thead>
                 <tbody id="picking-body">
                    <tr><td colspan="5" class="text-center py-4">Memuat data stok...</td></tr>
                 </tbody>
                 <tfoot class="table-light sticky-bottom">
                    <tr>
                       <td colspan="3" class="text-end fw-bold align-middle">TOTAL PICKED:</td>
                       <td colspan="2" class="text-center align-middle">
                          <span id="p-total-picked" class="fs-4 fw-bold text-danger">0</span>
                          <span class="text-muted mx-1">/</span>
                          <span id="p-total-target" class="fw-bold">0</span>
                       </td>
                    </tr>
                 </tfoot>
              </table>
           </div>
        </div>
        <div class="modal-footer justify-content-between">
           <span id="p-msg" class="small text-danger fw-bold ms-2"></span>
           <button type="button" class="btn-primary-custom" id="btn-save-pick" onclick="savePicking()" disabled>
              <i class="material-icons align-middle me-2">check</i> SIMPAN PICKING
           </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalScanner" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content bg-black">
        <div class="modal-body p-0"><div id="reader"></div></div>
        <div class="modal-footer border-0 p-2 justify-content-center bg-black"><button class="btn btn-sm btn-outline-light w-100" onclick="stopScanner()">Tutup Kamera</button></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ============================================================
    // A. GLOBAL VARIABLE & SETUP
    // ============================================================
    let cart = []; // Array of { sku, nama, brand, notes, reqQty, pickedQty, pickDetails: [] }
    let masterProduk = [];
    let modalInputBS, modalPickingBS, modalScannerBS;
    let html5QrcodeScanner = null;
    let editingIndex = -1; 

    document.addEventListener("DOMContentLoaded", function() {
      // Set Default Date
      document.getElementById('h-tanggal').valueAsDate = new Date();
      
      // Init Modals
      modalInputBS = new bootstrap.Modal(document.getElementById('modalInput'));
      modalPickingBS = new bootstrap.Modal(document.getElementById('modalPicking'));
      modalScannerBS = new bootstrap.Modal(document.getElementById('modalScanner'));
      
      // Load Storage Draft (jika ada)
      loadFromStorage();
      
      // Load Master Produk untuk Datalist Search
      google.script.run.withSuccessHandler(d => {
        masterProduk = d;
        let list = document.getElementById("listProduk");
        list.innerHTML = "";
        d.forEach(r => { 
            let opt = document.createElement("option"); 
            opt.value = r[0]; 
            opt.label = r[1]; 
            list.appendChild(opt); 
        });
      }).getMasterData();
    });

    // ============================================================
    // B. LOGIKA INPUT REQUEST (DRAFTING)
    // ============================================================
    
    // 1. Auto Fill saat Pilih Barang
    function isiOtomatis() {
      const val = document.getElementById("i-kode").value.trim().toUpperCase(); 
      const found = masterProduk.find(r => String(r[0]).toUpperCase() === val || String(r[1]).toUpperCase() === val);
      
      if (found) { 
          document.getElementById("i-kode").value = found[0]; 
          document.getElementById("i-kode-asli").value = found[0]; 
          document.getElementById("i-nama").value = found[1]; 
          document.getElementById("i-brand").value = found[2]; 
          document.getElementById("i-notes-master").value = found[3] || "-";

          // Update Display Card
          document.getElementById("disp-nama").innerText = found[1]; 
          document.getElementById("disp-brand").innerText = "BRAND: " + found[2];
          document.getElementById("disp-notes").innerText = "NOTES: " + (found[3] || "-");

          // Focus ke Qty
          document.getElementById("i-qty-req").focus(); 
      }
    }

    // 2. Tambah Barang ke Tabel (Cart)
    function addToCart() {
       let sku = document.getElementById('i-kode-asli').value || document.getElementById('i-kode').value;
       let req = parseInt(document.getElementById('i-qty-req').value);

       if(!sku || !req || req <= 0) {
          Swal.fire("Data Kurang", "Pastikan Produk dipilih dan Qty Request > 0", "warning"); return;
       }

       // Cek Duplikat
       let exist = cart.find(x => x.sku === sku);
       if(exist) {
          Swal.fire("Duplicate", "SKU ini sudah ada di daftar.", "warning"); return;
       }

       // Buat Item Baru
       let item = {
          sku: sku,
          nama: document.getElementById('i-nama').value,
          brand: document.getElementById('i-brand').value,
          notes: document.getElementById('i-notes-master').value,
          reqQty: req,
          pickedQty: 0,
          pickDetails: [] // Nanti diisi saat Picking
       };

       cart.push(item);
       saveToStorage();
       renderCart();
       
       // Reset Form Input
       document.getElementById('i-kode').value = "";
       document.getElementById('i-kode-asli').value = "";
       document.getElementById('i-qty-req').value = "";
       document.getElementById("disp-nama").innerText = "- Pilih Barang Dulu -"; 
       document.getElementById("disp-brand").innerText = "BRAND: -";
       document.getElementById("disp-notes").innerText = "NOTES: -";
       
       modalInputBS.hide();
       
       Swal.fire({
         icon: 'success', title: 'Berhasil', text: 'Silakan klik tombol PICK di tabel untuk mengambil stok.', 
         timer: 1500, showConfirmButton: false
       });
    }

    // ============================================================
    // C. LOGIKA PICKING (BATCH TAKING)
    // ============================================================

    // 1. Buka Modal Picking & Panggil Backend
    function openPickingModal(index) {
       editingIndex = index;
       let item = cart[index];
       
       // Set Header Modal
       document.getElementById('p-sku').innerText = item.sku;
       document.getElementById('p-nama').innerText = item.nama;
       document.getElementById('p-req-qty').innerText = item.reqQty;
       document.getElementById('p-total-target').innerText = item.reqQty;
       document.getElementById('p-total-picked').innerText = "0"; // Reset view
       document.getElementById('btn-save-pick').disabled = true;
       
       // Loading Spinner
       let tbody = document.getElementById('picking-body');
       tbody.innerHTML = `<tr><td colspan="5" class="text-center py-5"><div class="spinner-border text-primary"></div><div class="mt-2 small text-muted">Mencari stok tersedia...</div></td></tr>`;
       
       modalPickingBS.show();

       // CALL BACKEND: getAvailableStockForPicking
       google.script.run
         .withSuccessHandler(stockList => {
            renderPickingTable(stockList, item);
         })
         .withFailureHandler(err => {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger fw-bold py-4">Error: ${err.message}</td></tr>`;
         })
         .getAvailableStockForPicking(item.sku);
    }

    // 2. Render Tabel Picking (Looping Stok)
    function renderPickingTable(stockList, cartItem) {
       let tbody = document.getElementById('picking-body');
       tbody.innerHTML = "";

       if(!stockList || stockList.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center py-5 text-danger fw-bold bg-light">STOK TIDAK TERSEDIA / KOSONG</td></tr>`;
          updatePickingTotal();
          return;
       }

       stockList.forEach((stk, idx) => {
          // Cek apakah batch ini sudah pernah dipick sebelumnya (untuk pre-fill input)
          let pickedVal = 0;
          let existingPick = cartItem.pickDetails.find(p => 
             p.batch === stk.batch && p.lokasi === stk.lokasi && p.exp === stk.exp
          );
          if(existingPick) pickedVal = existingPick.qty;

          // Format Atribut
          let attr = [];
          if(stk.sticker && stk.sticker != "-") attr.push(`<span class="badge bg-light text-dark border">ST:${stk.sticker}</span>`);
          if(stk.size && stk.size != "-") attr.push(`<span class="badge bg-light text-dark border">SZ:${stk.size}</span>`);
          if(stk.cover && stk.cover != "-") attr.push(`<span class="badge bg-light text-dark border">CV:${stk.cover}</span>`);
          
          let tr = document.createElement('tr');
          tr.innerHTML = `
             <td>
                <div class="fw-bold text-dark">${stk.lokasi}</div>
                <div class="small text-muted badge bg-secondary bg-opacity-10 text-secondary border">${stk.typeLoc}</div>
             </td>
             <td>
                <div class="font-monospace fw-bold text-primary">${stk.batch}</div>
                <div class="small text-muted">Exp: ${stk.exp || '-'}</div>
             </td>
             <td>${attr.join(' ') || '-'}</td>
             <td class="text-center fw-bold align-middle">${stk.qty}</td>
             <td class="text-center align-middle">
                <input type="number" class="picking-input form-control-sm" 
                   data-max="${stk.qty}" 
                   data-batch="${stk.batch}" 
                   data-loc="${stk.lokasi}" 
                   data-exp="${stk.exp}"
                   data-typeloc="${stk.typeLoc}"
                   data-sticker="${stk.sticker}"
                   data-size="${stk.size}"
                   data-cover="${stk.cover}"
                   value="${pickedVal}" 
                   min="0" max="${stk.qty}" 
                   oninput="updatePickingTotal()"
                   onfocus="this.select()">
             </td>
          `;
          tbody.appendChild(tr);
       });
       
       updatePickingTotal(); // Hitung total awal
    }

    // 3. Kalkulasi Real-time & Validasi
    function updatePickingTotal() {
       let inputs = document.querySelectorAll('.picking-input');
       let total = 0;
       
       inputs.forEach(inp => {
          let val = parseInt(inp.value);
          let max = parseInt(inp.getAttribute('data-max'));
          
          if(isNaN(val)) val = 0;
          
          // Validasi: Tidak boleh lebih dari stok
          if(val > max) { 
             val = max; 
             inp.value = max; 
          } 
          if(val < 0) { 
             val = 0; 
             inp.value = 0; 
          }
          
          total += val;
       });

       let req = parseInt(document.getElementById('p-total-target').innerText);
       let dispTotal = document.getElementById('p-total-picked');
       let msg = document.getElementById('p-msg');
       let btn = document.getElementById('btn-save-pick');

       dispTotal.innerText = total;
       
       // Logika Tombol Simpan
       if(total === req) {
          dispTotal.className = "fs-4 fw-bold text-success";
          msg.innerText = "PAS! Siap disimpan.";
          msg.className = "small text-success fw-bold ms-2";
          btn.disabled = false;
          btn.classList.remove('btn-secondary');
          btn.classList.add('btn-primary-custom');
       } else if (total > req) {
          dispTotal.className = "fs-4 fw-bold text-danger";
          msg.innerText = "KELEBIHAN! Kurangi input.";
          msg.className = "small text-danger fw-bold ms-2";
          btn.disabled = true;
       } else {
          dispTotal.className = "fs-4 fw-bold text-warning";
          msg.innerText = `KURANG ${req - total} pcs lagi.`;
          msg.className = "small text-warning fw-bold ms-2";
          btn.disabled = true; // Matikan tombol jika belum pas (sesuai best practice)
       }
    }

    // 4. Simpan Picking ke Cart
    function savePicking() {
       let inputs = document.querySelectorAll('.picking-input');
       let newDetails = [];
       let totalPicked = 0;

       inputs.forEach(inp => {
          let qty = parseInt(inp.value) || 0;
          if(qty > 0) {
             newDetails.push({
                batch: inp.getAttribute('data-batch'),
                lokasi: inp.getAttribute('data-loc'),
                exp: inp.getAttribute('data-exp'),
                typeLokasi: inp.getAttribute('data-typeloc'),
                typeSticker: inp.getAttribute('data-sticker'),
                size: inp.getAttribute('data-size'),
                sizeCover: inp.getAttribute('data-cover'),
                qty: qty
             });
             totalPicked += qty;
          }
       });

       // Update Cart Global
       if(editingIndex >= 0) {
          cart[editingIndex].pickDetails = newDetails;
          cart[editingIndex].pickedQty = totalPicked;
       }

       saveToStorage();
       renderCart();
       modalPickingBS.hide();
       
       Swal.fire({
         icon: 'success', title: 'Picking Tersimpan', toast: true, position: 'top-end', showConfirmButton: false, timer: 1000
       });
    }

    // ============================================================
    // D. FINALISASI & RENDER UTAMA
    // ============================================================

    function renderCart() {
       let tbody = document.getElementById('cart-body'); 
       tbody.innerHTML = "";
       
       if(cart.length === 0) { 
          tbody.innerHTML = `<tr><td colspan="6" class="p-5 text-center text-muted">Belum ada barang. Klik Tambah SKU.</td></tr>`; 
          document.getElementById('total-items').innerText = "0 Item"; 
          validateOutboundButtons(); // Update tombol validate
          return; 
       }
       
       cart.forEach((item, index) => {
          // Progress Bar Visual
          let progressPercent = (item.pickedQty / item.reqQty) * 100;
          let progressClass = "progress-bar-picking";
          if(progressPercent >= 100) progressClass += " progress-complete";

          // Detail Picking di Tabel Utama
          let pickInfo = "";
          if(item.pickDetails.length > 0) {
             pickInfo = `<div class="d-flex flex-column gap-1">`;
             item.pickDetails.forEach(d => {
                pickInfo += `<span class="badge bg-white text-dark border d-flex justify-content-between align-items-center px-2 py-1" style="font-size:11px;">
                   <span><i class="material-icons align-middle text-muted me-1" style="font-size:12px">place</i>${d.lokasi} <span class="text-muted">[${d.batch}]</span></span> 
                   <strong class="text-primary">${d.qty}</strong>
                </span>`;
             });
             pickInfo += `</div>`;
          } else {
             pickInfo = `<span class="badge bg-warning text-dark bg-opacity-25 border border-warning" style="font-size:10px">BELUM DIPICKING</span>`;
          }

          let tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="text-center fw-bold text-muted">${index + 1}</td>
            <td>
                <div class="fw-bold text-dark">${item.nama}</div>
                <div class="small text-muted font-monospace">${item.sku}</div>
            </td>
            <td class="text-center align-middle">
               <span class="fs-5 fw-bold text-dark">${item.reqQty}</span>
            </td>
            <td class="text-center align-middle">
               <span class="fs-5 fw-bold ${item.pickedQty >= item.reqQty ? 'text-success' : 'text-danger'}">${item.pickedQty}</span>
               <div class="progress-picking"><div class="${progressClass}" style="width:${progressPercent}%"></div></div>
            </td>
            <td class="align-top pt-3 bg-light bg-opacity-50">${pickInfo}</td>
            <td class="text-end align-middle">
               <div class="btn-action-group">
                  <button class="btn btn-sm btn-primary text-white" onclick="openPickingModal(${index})">
                     <i class="material-icons" style="font-size:16px">move_to_inbox</i> PICK
                  </button>
                  <button class="btn btn-sm btn-light text-danger border" onclick="hapusCart(${index})">
                     <i class="material-icons" style="font-size:16px">delete</i>
                  </button>
               </div>
            </td>
          `;
          tbody.appendChild(tr);
       });
       document.getElementById('total-items').innerText = `${cart.length} Item`;
       validateOutboundButtons();
    }

    // Tombol Validasi hanya aktif jika semua barang sudah dipick 100%
    function validateOutboundButtons() {
       let btn = document.getElementById('btn-validate');
       if(cart.length === 0) { btn.disabled = true; return; }
       
       let allComplete = cart.every(i => i.pickedQty >= i.reqQty);
       
       if(allComplete) {
          btn.disabled = false;
       } else {
          btn.disabled = true;
       }
    }

    // FINAL: Simpan Transaksi
    function validateOutbound() {
       let header = {
          tanggal: document.getElementById('h-tanggal').value,
          docNo: document.getElementById('h-docNo').value.toUpperCase(),
          customer: document.getElementById('h-customer').value.toUpperCase(),
          notes: document.getElementById('h-notes').value.toUpperCase()
       };

       if(!header.tanggal || !header.docNo || !header.customer) {
          Swal.fire("Header Kurang", "Tanggal, No Dokumen, dan Customer Wajib Diisi!", "error"); return;
       }

       Swal.fire({ 
          title: 'Proses Outbound?', 
          text: `Akan mengeluarkan ${cart.length} SKU dan mengurangi stok batch terkait.`, 
          icon: 'warning', 
          showCancelButton: true, 
          confirmButtonText: 'YA, PROSES', 
          confirmButtonColor: '#2563eb' 
       }).then((result) => { 
          if (result.isConfirmed) { 
             let btn = document.getElementById('btn-validate'); 
             let oriText = btn.innerHTML;
             btn.innerHTML = "MEMPROSES..."; btn.disabled = true; 
             
             google.script.run.withSuccessHandler((res) => { 
                if(res.success) { 
                   
                   // [REVISI] POPUP SUKSES DENGAN TOMBOL CETAK
                   Swal.fire({
                      title: 'Outbound Berhasil!',
                      html: `ID Transaksi: <b>${res.trxId}</b><br>Stok berhasil dikurangi.`,
                      icon: 'success',
                      showCancelButton: true,
                      confirmButtonText: 'ðŸ–¨ï¸ CETAK SURAT JALAN', // Tombol Print
                      cancelButtonText: 'Tutup',
                      confirmButtonColor: '#000',
                      allowOutsideClick: false
                   }).then((printRes) => {
                      if (printRes.isConfirmed) {
                          // Buka Tab Baru ke Halaman Cetak
                          window.open("<?= scriptUrl ?>?page=CetakSuratJalan&id=" + res.trxId, '_blank');
                      }
                   });
                   
                   // Update UI Status (Tetap jalan di background)
                   document.getElementById('status-draft').style.display = 'none'; 
                   document.getElementById('status-done').style.display = 'inline-block'; 
                   document.getElementById('final-trx-id').innerText = res.trxId; 
                   
                   // Kunci Layar
                   document.querySelectorAll('input, button, textarea').forEach(e => e.disabled = true); 
                   document.querySelector('.btn-close').disabled = false;
                   
                   cart = []; saveToStorage(); 

                } else { 
                   Swal.fire("Gagal", res.message, "error"); 
                   btn.innerHTML = oriText; 
                   btn.disabled = false; 
                } 
             }).processOutboundTransaction(header, cart); 
          } 
       });
    }

    // --- Helper UI ---
    function hapusCart(index) { cart.splice(index, 1); saveToStorage(); renderCart(); }
    function resetAll() { if(cart.length>0 && !confirm("Reset Form?")) return; localStorage.removeItem("wms_outbound_cart"); location.reload(); }
    function saveToStorage() { localStorage.setItem("wms_outbound_cart", JSON.stringify(cart)); }
    function loadFromStorage() { let s = localStorage.getItem("wms_outbound_cart"); if(s) { cart = JSON.parse(s); renderCart(); } }

    function openInputModal() { 
       document.getElementById('i-qty-req').value = "";
       document.getElementById('i-kode').value = "";
       document.getElementById('i-kode-asli').value = "";
       modalInputBS.show(); 
       setTimeout(() => document.getElementById('i-kode').focus(), 500); 
    }

    function bukaScanner() { modalScannerBS.show(); setTimeout(() => { if (!html5QrcodeScanner) html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 20, qrbox: 200 }, false); html5QrcodeScanner.render(onScanSuccess); }, 500); }
    function onScanSuccess(txt) { if (html5QrcodeScanner) html5QrcodeScanner.pause(); document.getElementById("i-kode").value = txt; isiOtomatis(); modalScannerBS.hide(); stopScanner(); }
    function stopScanner() { if(html5QrcodeScanner) { html5QrcodeScanner.clear(); } modalScannerBS.hide(); }
  </script>
</body>
</html>
