<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --primary: #2563eb; --bg-body: #F8FAFC; --bg-card: #ffffff;
      --text-main: #1e293b; --text-muted: #64748b; --border-color: #e2e8f0;
    }
    body { background-color: var(--bg-body); font-family: 'Inter', sans-serif; font-size: 13px; }
    .content-wrapper { padding: 24px; max-width: 1600px; margin: 0 auto; }
    
    .filter-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 24px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .filter-label { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; }
    .form-control, .form-select { font-size: 13px; border-radius: 6px; }
    
    .btn-wms { font-weight: 600; font-size: 13px; padding: 8px 20px; border-radius: 6px; }
    .btn-primary-wms { background: var(--primary); color: white; border: none; }
    
    .table-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
    .wms-table { width: 100%; border-collapse: separate; border-spacing: 0; }
    .wms-table thead { background: #f8fafc; }
    .wms-table th { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); padding: 14px 16px; border-bottom: 1px solid var(--border-color); }
    .wms-table td { padding: 14px 16px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
    .wms-table tr:last-child td { border-bottom: none; }
    
    /* --- NEW ACTION COLUMN STYLE --- */
    .action-col {
      display: flex; 
      align-items: center; 
      justify-content: flex-end; 
      gap: 12px; 
    }
    
    .btn-action-icon {
      color: #94a3b8; 
      cursor: pointer;
      transition: all 0.2s;
      font-size: 20px;
      display: flex; align-items: center;
    }
    .btn-action-icon:hover { color: #334155; transform: scale(1.1); }
    
    .btn-action-delete {
      color: #ef4444; 
      cursor: pointer;
      transition: all 0.2s;
      font-size: 20px;
      display: flex; align-items: center;
    }
    .btn-action-delete:hover { color: #b91c1c; transform: scale(1.1); }

    .btn-action-show {
      font-size: 12px;
      font-weight: 700;
      color: #2563eb; 
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 4px 8px;
      border-radius: 4px;
      transition: 0.2s;
      margin-left: 4px; 
    }
    .btn-action-show:hover { background-color: #eff6ff; color: #1d4ed8; }

    /* Modal Detail */
    .detail-table th { background: #f1f5f9; font-size: 11px; }
    .detail-table td { font-size: 12px; }

    /* Styling Khusus Notes */
    .master-notes-text {
      display: block;
      margin-top: 4px;
      font-size: 11px;
      color: #64748b; /* Warna Abu-abu */
      font-style: italic;
    }
    .master-notes-text i {
        font-size: 10px; 
        vertical-align: middle; 
        margin-right: 2px;
    }
  </style>
</head>
<body>

  <?!= include('Sidebar', {scriptUrl: scriptUrl, page: page}); ?>

  <div class="content"> 
    <div class="content-wrapper">
      
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div><h4 class="fw-bold m-0 text-dark">Monitoring Inbound</h4><p class="text-muted m-0 small">Ringkasan transaksi penerimaan.</p></div>
        <button class="btn btn-wms btn-primary-wms" onclick="exportCSV()"><i class="material-icons align-middle me-1" style="font-size:16px;">file_download</i> CSV</button>
      </div>

      <div class="filter-card">
        <div class="row g-3">
          <div class="col-md-3"><div class="filter-label">Search (PO/ID)</div><input type="text" id="filterSearch" class="form-control" placeholder="Ketik..."></div>
          <div class="col-md-2"><div class="filter-label">Start Date</div><input type="date" id="startDate" class="form-control"></div>
          <div class="col-md-2"><div class="filter-label">End Date</div><input type="date" id="endDate" class="form-control"></div>
          <div class="col-md-3 d-flex align-items-end"><button class="btn btn-wms btn-primary-wms w-100" onclick="loadHistory()">SEARCH</button></div>
        </div>
      </div>

      <div class="table-card">
        <div class="table-responsive">
          <table class="wms-table">
            <thead>
              <tr>
                <th>Inbound ID</th>
                <th>Tanggal</th>
                <th>PO Produk / Sticker</th>
                <th class="text-center">Total Item</th>
                <th class="text-center">Total Qty</th>
                <th>User</th>
                <th class="text-end" style="min-width: 180px;">Action</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr><td colspan="7" class="text-center py-5 text-muted">Memuat data...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">Detail Inbound</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-4">
          
          <div class="row g-3 mb-4 border-bottom pb-3">
             <div class="col-md-3"><small class="text-muted d-block">ID Transaksi</small><strong id="d-id" class="text-primary font-monospace">-</strong></div>
             <div class="col-md-3"><small class="text-muted d-block">Tanggal</small><strong id="d-date">-</strong></div>
             <div class="col-md-3"><small class="text-muted d-block">PO Produk</small><strong id="d-po">-</strong></div>
             <div class="col-md-3"><small class="text-muted d-block">User</small><strong id="d-user">-</strong></div>
          </div>

          <h6 class="fw-bold text-muted text-uppercase mb-3 small">Daftar Barang</h6>
          <div class="table-responsive border rounded">
            <table class="table mb-0 table-striped detail-table">
              <thead>
                <tr>
                  <th width="25%">SKU / Nama</th>
                  <th width="10%">Brand</th>
                  <th width="15%">Batch / Exp</th>
                  <th width="10%">Lokasi</th>
                  <th width="20%">Atribut</th>
                  <th width="15%">Notes (Keterangan)</th> <th width="5%" class="text-end">Qty</th>
                </tr>
              </thead>
              <tbody id="detailItemsBody"></tbody>
            </table>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let globalData = [];
    let masterProdukCache = []; // Variabel untuk menyimpan Master Data
    let detailModalBS;

    document.addEventListener("DOMContentLoaded", function() {
      detailModalBS = new bootstrap.Modal(document.getElementById('detailModal'));
      
      // Load Master Data saat halaman dimuat untuk referensi Notes Master (Area Merah)
      google.script.run.withSuccessHandler(data => {
          masterProdukCache = data;
      }).getMasterData();

      loadHistory();
    });

    function loadHistory() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      
      document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>';

      google.script.run
        .withSuccessHandler(renderTable)
        .withFailureHandler(err => document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error: '+err.message+'</td></tr>')
        .getInboundHistory(start, end);
    }

    function renderTable(data) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = "";
      
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted">Tidak ada data.</td></tr>';
        return;
      }

      globalData = data; 

      const search = document.getElementById('filterSearch').value.toLowerCase();
      const filtered = data.filter(r => r.id.toLowerCase().includes(search) || r.poProduk.toLowerCase().includes(search));

      filtered.forEach(row => {
        let tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="font-monospace fw-bold text-primary">${row.id}</td>
          <td>${row.tgl}</td>
          <td>
             <div class="fw-bold text-dark">${row.poProduk}</div>
             <div class="small text-muted">${row.poSticker || '-'}</div>
          </td>
          <td class="text-center"><span class="badge bg-light text-dark border">${row.items.length} SKU</span></td>
          <td class="text-center"><span class="badge bg-success bg-opacity-10 text-success border border-success fw-bold px-3">${row.totalQty}</span></td>
          <td>
             <div class="d-flex align-items-center">
                <div class="bg-light rounded-circle text-muted d-flex align-items-center justify-content-center me-2" style="width:24px;height:24px;font-size:10px;">AD</div>
                <span>${row.user}</span>
             </div>
          </td>
          <td class="text-end">
            <div class="action-col">
              <i class="material-icons btn-action-icon" onclick="printLabel('${row.id}')" title="Print Label">print</i>
              <i class="material-icons btn-action-icon" onclick="printPicking('${row.id}')" title="Print Picking">receipt_long</i>
              <i class="material-icons btn-action-delete" onclick="hapus('${row.id}')" title="Hapus">delete</i>
              <span class="btn-action-show" onclick="showDetail('${row.id}')">SHOW</span>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function showDetail(id) {
      const trx = globalData.find(x => x.id === id);
      if(!trx) return;

      document.getElementById('d-id').innerText = trx.id;
      document.getElementById('d-date').innerText = trx.tgl;
      document.getElementById('d-po').innerText = trx.poProduk;
      document.getElementById('d-user').innerText = trx.user;

      const tbody = document.getElementById('detailItemsBody');
      tbody.innerHTML = "";

      trx.items.forEach(item => {
         let tr = document.createElement('tr');
         let attr = [];
         if(item.typeSticker && item.typeSticker != "-") attr.push(`ST: ${item.typeSticker}`);
         if(item.size && item.size != "-") attr.push(`SZ: ${item.size}`);
         if(item.sizeCover && item.sizeCover != "-") attr.push(`CV: ${item.sizeCover}`);

         // --- LOGIKA MENGAMBIL NOTES MASTER (AREA MERAH) ---
         // Mencari data di cache Master Produk berdasarkan Kode Barang
         let masterData = masterProdukCache.find(m => String(m[0]) === String(item.kode));
         let masterNoteText = (masterData && masterData[3]) ? masterData[3] : "-";
         
         // Jika Master Note ada isinya, buat HTML-nya
         let masterNoteHTML = "";
         if(masterNoteText !== "-" && masterNoteText !== "") {
             masterNoteHTML = `<span class="master-notes-text"><i class="material-icons">info</i> ${masterNoteText}</span>`;
         }

         // --- LOGIKA KETERANGAN MANUAL (AREA HIJAU) ---
         // item.notes pada Code.gs getInboundHistory() sebenarnya berisi kolom 'Keterangan' dari database transaksi
         let userNoteText = item.notes; 

         tr.innerHTML = `
           <td>
              <div class="fw-bold text-dark">${item.nama}</div>
              <div class="small text-muted font-monospace">${item.kode}</div>
              ${masterNoteHTML}
           </td>
           <td>${item.brand}</td>
           <td>
              <div class="small fw-bold">B: ${item.batch}</div>
              <div class="small text-danger">E: ${item.exp}</div>
           </td>
           <td><span class="badge bg-light text-dark border">${item.typeLoc}</span> <b>${item.lokasi}</b></td>
           <td class="small text-muted">${attr.join(', ') || '-'}</td>
           
           <td class="small fst-italic text-dark">${userNoteText}</td>
           
           <td class="text-end fw-bold fs-6">${item.qty}</td>
         `;
         tbody.appendChild(tr);
      });

      detailModalBS.show();
    }

    // --- ACTIONS ---
    function printLabel(id) { Swal.fire('Print Label', 'Mencetak label untuk ID: '+id, 'info'); }
    function printPicking(id) { Swal.fire('Print Picking', 'Mencetak picking list: '+id, 'info'); }
    function exportCSV() { Swal.fire('Export', 'Fitur export CSV', 'success'); }
    
    function hapus(id) {
       Swal.fire({title:'Hapus Transaksi?', text:'Semua item dalam ID ini akan dihapus!', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33', confirmButtonText:'Hapus'}).then(res=>{
          if(res.isConfirmed) {
             google.script.run.withSuccessHandler(r=>{
                if(r.success) { loadHistory(); Swal.fire('Terhapus','','success'); }
                else Swal.fire('Gagal', r.message, 'error');
             }).deleteInboundTransaction(id);
          }
       });
    }
  </script>
</body>
</html>
