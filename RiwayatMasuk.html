<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root { --primary: #4f46e5; --bg-body: #f8fafc; }
    body { background-color: var(--bg-body); font-family: 'Inter', sans-serif; font-size: 13px; }
    .content { margin-left: 250px; padding: 25px 40px; }
    .filter-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .table-card { background: #fff; border-radius: 8px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .btn-export { background: #7c3aed; color: white; font-weight: 600; font-size: 12px; }
    .badge-qty { font-weight: 700; color: #059669; background: #ecfdf5; padding: 4px 10px; border-radius: 20px; border: 1px solid #a7f3d0; }
  </style>
</head>
<body>

  <?!= include('Sidebar', {scriptUrl: scriptUrl, page: page}); ?>

  <div class="content">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h4 class="fw-bold m-0 text-dark">Monitoring Inbound</h4>
        <div class="text-muted small">Lacak riwayat penerimaan barang.</div>
      </div>
      <button class="btn btn-export shadow-sm px-3 py-2 border-0" onclick="exportCSV()">
        <i class="material-icons align-middle me-1" style="font-size:16px">file_download</i> EXPORT CSV
      </button>
    </div>

    <div class="filter-card p-3">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label small fw-bold text-muted">Cari (PO / SKU)</label>
          <input type="text" class="form-control" id="smartSearch" placeholder="Ketik...">
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-bold text-muted">Type Lokasi</label>
          <select class="form-select" id="filterType">
            <option value="">Semua</option>
            <option value="Excel">Excel</option>
            <option value="Koli">Koli</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-bold text-muted">Dari Tanggal</label>
          <input type="date" class="form-control" id="startDate">
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-bold text-muted">Sampai Tanggal</label>
          <input type="date" class="form-control" id="endDate">
        </div>
        <div class="col-md-3">
           <button class="btn btn-primary w-100 fw-bold" onclick="loadHistory()">TERAPKAN & CARI</button>
        </div>
      </div>
    </div>

    <div class="table-card">
      <div class="table-responsive">
        <table id="tableRiwayat" class="table w-100 mb-0">
          <thead class="bg-light">
            <tr>
              <th>ID & Tanggal</th>
              <th>Referensi (PO)</th>
              <th>Nama Barang / SKU</th>
              <th>Batch Info</th>
              <th>Lokasi</th>
              <th class="text-center">Qty</th>
              <th class="text-center">Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>

  <script>
    let table;

    document.addEventListener("DOMContentLoaded", function() {
       loadHistory();

       document.getElementById('smartSearch').addEventListener('keyup', function() {
          if(table) table.search(this.value).draw();
       });
       document.getElementById('filterType').addEventListener('change', function() {
          if(table) table.column(4).search(this.value).draw();
       });
    });

    function loadHistory() {
       const start = document.getElementById('startDate').value;
       const end = document.getElementById('endDate').value;

       if ($.fn.DataTable.isDataTable('#tableRiwayat')) {
           $('#tableRiwayat').DataTable().clear().destroy();
       }
       document.querySelector('#tableRiwayat tbody').innerHTML = '<tr><td colspan="7" class="text-center p-5 text-muted"><div class="spinner-border text-primary spinner-border-sm mb-2"></div><br>Mengambil data...</td></tr>';

       google.script.run
         .withSuccessHandler(renderTable)
         .withFailureHandler(function(err){
             document.querySelector('#tableRiwayat tbody').innerHTML = `<tr><td colspan="7" class="text-center text-danger p-5"><b>Error Koneksi:</b> ${err.message}</td></tr>`;
         })
         .getInboundHistory(start, end);
    }

    function renderTable(data) {
       const tbody = document.querySelector('#tableRiwayat tbody');
       tbody.innerHTML = "";

       if (!data || data.length === 0) {
           tbody.innerHTML = '<tr><td colspan="7" class="text-center p-5 text-muted">Tidak ada data inbound.</td></tr>';
           return;
       }

       data.forEach(row => {
          let tr = document.createElement('tr');
          
          // OPSI A: NOTES GABUNG DI KOLOM NAMA BARANG
          let noteHtml = (row.notes && row.notes !== "-" && row.notes.trim() !== "") 
              ? `<div class="mt-1 small text-danger fst-italic border-top pt-1" style="font-size:11px;">
                   <i class="material-icons align-middle" style="font-size:12px">campaign</i> ${row.notes}
                 </div>` 
              : "";

          tr.innerHTML = `
            <td>
                <div class="fw-bold text-dark font-monospace">${row.id}</div>
                <div class="text-muted small">${row.tgl}</div>
            </td>
            <td>
                <div class="fw-bold text-dark">${row.poSticker}</div>
                <div class="text-muted small">${row.poProduk}</div>
            </td>
            <td>
                <div class="fw-bold text-primary">${row.nama}</div>
                <div class="small bg-light border px-1 rounded d-inline-block text-muted">${row.kode}</div>
                ${noteHtml}
            </td>
            <td>
                <div class="small">Batch: <b>${row.batch}</b></div>
                <div class="small text-danger">Exp: ${row.exp}</div>
            </td>
            <td>
                <span class="badge bg-light text-dark border small">${row.typeLoc}</span>
                <span class="ms-1 small fw-bold text-muted">${row.lokasi}</span>
            </td>
            <td class="text-center">
                <span class="badge-qty">${row.qty}</span>
            </td>
            <td class="text-center">
                <button class="btn btn-link text-danger p-0" onclick="hapus('${row.id}')" title="Hapus"><i class="material-icons">delete</i></button>
            </td>
          `;
          tbody.appendChild(tr);
       });

       table = $('#tableRiwayat').DataTable({
          dom: 't<"d-flex justify-content-between mt-3"ip>',
          pageLength: 10,
          columnDefs: [ { "orderable": false, "targets": 6 } ]
       });
    }

    function exportCSV() {
       if(!table) return;
       new $.fn.dataTable.Buttons(table, { buttons: [{ extend: 'csvHtml5', className: 'd-none' }] }).container().appendTo('body');
       table.button('.buttons-csv').trigger();
    }

    function hapus(id) {
       Swal.fire({title:'Hapus?', icon:'warning', showCancelButton:true, confirmButtonText:'Ya', confirmButtonColor:'#d33'}).then(res=>{
          if(res.isConfirmed) {
             google.script.run.withSuccessHandler(r=>{
                if(r.success) { loadHistory(); Swal.fire('Dihapus','','success'); }
                else Swal.fire('Gagal', r.message, 'error');
             }).deleteInboundTransaction(id);
          }
       });
    }
  </script>
</body>
</html>