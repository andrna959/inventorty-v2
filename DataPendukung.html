<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    body { background-color: #f3f4f6; font-family: 'Inter', sans-serif; }
    .content { margin-left: 250px; padding: 30px; }
    
    .card-list { height: 350px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; background: #fff; }
    .list-group-item { display: flex; justify-content: space-between; align-items: center; border: none; border-bottom: 1px solid #f3f4f6; padding: 10px 15px; font-size: 13px; color: #374151; }
    .list-group-item:hover { background-color: #f9fafb; }
    
    .card-header-custom { font-weight: 700; text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px; padding: 12px 15px; background: white; border-bottom: 1px solid #e5e7eb; border-top-width: 3px; border-top-style: solid; }
    .header-primary { border-top-color: #2563eb; color: #2563eb; }
    .header-success { border-top-color: #059669; color: #059669; }
    .header-warning { border-top-color: #d97706; color: #d97706; }
    .header-info { border-top-color: #0891b2; color: #0891b2; }

    /* Action Buttons */
    .btn-action { cursor: pointer; transition: 0.2s; margin-left: 8px; }
    .btn-edit { color: #f59e0b; } /* Kuning */
    .btn-delete { color: #ef4444; } /* Merah */
    .btn-action:hover { transform: scale(1.2); }
  </style>
</head>
<body>

  <?!= include('Sidebar', {scriptUrl: scriptUrl, page: page}); ?>

  <div class="content">
    <div class="mb-4">
      <h3 class="fw-bold m-0 text-dark">Data Pendukung</h3>
      <span class="text-muted small">Kelola master data pendukung dengan validasi ketat.</span>
    </div>

    <div class="row g-4">
      
      <div class="col-md-6 col-lg-3">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-header-custom header-primary">
            <i class="material-icons align-middle me-1">place</i> Daftar Lokasi
          </div>
          <div class="p-3 bg-light border-bottom">
            <input type="text" class="form-control form-control-sm mb-2" id="input-lokasi-kode" placeholder="Kode (Wajib EX.. atau KL..)">
            <select class="form-select form-select-sm mb-2" id="input-lokasi-tipe">
              <option value="" disabled selected>- Pilih Kategori -</option>
              <option value="Excel">Area Excel (Eceran)</option>
              <option value="Koli">Area Koli (Kardusan)</option>
            </select>
            <button class="btn btn-primary btn-sm w-100" onclick="addLokasi()">+ Tambah Lokasi</button>
          </div>
          <div class="card-list" id="list-lokasi">Loading...</div>
        </div>
      </div>

      <div class="col-md-6 col-lg-3">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-header-custom header-success"><i class="material-icons align-middle me-1">straighten</i> Size Produk</div>
          <div class="p-3 bg-light border-bottom">
            <div class="input-group">
              <input type="text" class="form-control form-control-sm" id="input-size" placeholder="Misal: XL">
              <button class="btn btn-success btn-sm text-white" onclick="add('size')">Add</button>
            </div>
          </div>
          <div class="card-list" id="list-size">Loading...</div>
        </div>
      </div>

      <div class="col-md-6 col-lg-3">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-header-custom header-warning"><i class="material-icons align-middle me-1">style</i> Type Sticker</div>
          <div class="p-3 bg-light border-bottom">
            <div class="input-group">
              <input type="text" class="form-control form-control-sm" id="input-typeSticker" placeholder="Misal: Vinyl">
              <button class="btn btn-warning btn-sm text-white" onclick="add('typeSticker')">Add</button>
            </div>
          </div>
          <div class="card-list" id="list-typeSticker">Loading...</div>
        </div>
      </div>

      <div class="col-md-6 col-lg-3">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-header-custom header-info"><i class="material-icons align-middle me-1">aspect_ratio</i> Size Cover</div>
          <div class="p-3 bg-light border-bottom">
            <div class="input-group">
              <input type="text" class="form-control form-control-sm" id="input-sizeCover" placeholder="Misal: 15 cm">
              <button class="btn btn-info btn-sm text-white" onclick="add('sizeCover')">Add</button>
            </div>
          </div>
          <div class="card-list" id="list-sizeCover">Loading...</div>
        </div>
      </div>

    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", loadAllData);

    function loadAllData() {
      google.script.run.withSuccessHandler(renderAll).getSupportingData();
    }

    function renderAll(data) {
      renderList('list-lokasi', data.lokasi, 'lokasi');
      renderList('list-size', data.size, 'size');
      renderList('list-typeSticker', data.typeSticker, 'typeSticker');
      renderList('list-sizeCover', data.sizeCover, 'sizeCover');
    }

    function renderList(elementId, arrayData, category) {
      const container = document.getElementById(elementId);
      container.innerHTML = "";
      
      if(!arrayData || arrayData.length === 0) {
        container.innerHTML = '<div class="text-center text-muted p-3 small">Belum ada data</div>';
        return;
      }

      arrayData.forEach(item => {
        const div = document.createElement("div");
        div.className = "list-group-item";
        
        let displayHTML = item;
        let editValue = item;
        let extraAttr = ""; 

        if(category === 'lokasi' && item.includes(' - ')) {
            let parts = item.split(' - ');
            displayHTML = `<strong>${parts[0]}</strong> <span class="badge bg-secondary ms-2" style="font-size:10px">${parts[1]}</span>`;
            editValue = parts[0]; 
            extraAttr = parts[1];
        }

        div.innerHTML = `
          <span>${displayHTML}</span>
          <div>
            <i class="material-icons btn-action btn-edit" style="font-size:18px" onclick="editItem('${category}', '${item}', '${editValue}', '${extraAttr}')">edit</i>
            <i class="material-icons btn-action btn-delete" style="font-size:18px" onclick="hapus('${category}', '${item}')">delete</i>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // --- 1. VALIDASI & TAMBAH LOKASI ---
    function addLokasi() {
        const kode = document.getElementById('input-lokasi-kode').value.trim().toUpperCase();
        const tipe = document.getElementById('input-lokasi-tipe').value;

        if(!kode || !tipe) {
            Swal.fire("Data Kurang", "Kode Lokasi dan Tipe Kategori wajib diisi!", "warning");
            return;
        }

        // VALIDASI LOGIKA (Mencegah Salah Kamar)
        if(kode.startsWith("EX") && tipe !== "Excel") {
            Swal.fire("Logika Salah", "Kode berawalan 'EX' wajib masuk kategori Excel (Eceran)!", "error");
            return;
        }
        if(kode.startsWith("KL") && tipe !== "Koli") {
            Swal.fire("Logika Salah", "Kode berawalan 'KL' wajib masuk kategori Koli (Kardusan)!", "error");
            return;
        }
        // Validasi Pola Umum
        if(!kode.startsWith("EX") && !kode.startsWith("KL")) {
             Swal.fire("Format Salah", "Kode Lokasi harus berawalan 'EX' atau 'KL'!", "warning");
             return;
        }

        google.script.run.withSuccessHandler((res) => {
            if(res.success) {
                document.getElementById('input-lokasi-kode').value = "";
                document.getElementById('input-lokasi-tipe').value = "";
                loadAllData();
                Swal.fire({ icon: 'success', title: 'Berhasil', toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 });
            } else {
                Swal.fire("Gagal", res.message, "error");
            }
        }).addSupportItem('lokasi', kode, tipe);
    }

    // --- 2. EDIT ITEM ---
    async function editItem(category, fullString, currentValue, currentType) {
        let htmlForm = '';
        if (category === 'lokasi') {
             htmlForm = `
               <input id="edit-kode" class="swal2-input" value="${currentValue}" placeholder="Kode">
               <select id="edit-tipe" class="swal2-select" style="display:flex; margin: 1em auto; width:80%">
                 <option value="Excel" ${currentType === 'Excel' ? 'selected' : ''}>Area Excel</option>
                 <option value="Koli" ${currentType === 'Koli' ? 'selected' : ''}>Area Koli</option>
               </select>
             `;
        } else {
             htmlForm = `<input id="edit-val" class="swal2-input" value="${currentValue}">`;
        }

        const { value: formValues } = await Swal.fire({
            title: 'Edit Data',
            html: htmlForm,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Update',
            preConfirm: () => {
                if (category === 'lokasi') {
                    return [
                      document.getElementById('edit-kode').value.toUpperCase(),
                      document.getElementById('edit-tipe').value
                    ];
                } else {
                    return [document.getElementById('edit-val').value.toUpperCase()]; // Force Uppercase
                }
            }
        });

        if (formValues) {
            const newValue = formValues[0];
            const newType = formValues[1] || null;

            if(!newValue) return;

            // VALIDASI SAAT EDIT LOKASI
            if (category === 'lokasi') {
                 if(newValue.startsWith("EX") && newType !== "Excel") {
                    Swal.fire("Logika Salah", "Kode EX harus Excel!", "error"); return;
                 }
                 if(newValue.startsWith("KL") && newType !== "Koli") {
                    Swal.fire("Logika Salah", "Kode KL harus Koli!", "error"); return;
                 }
            }

            google.script.run.withSuccessHandler((res) => {
                if(res.success) {
                   loadAllData();
                   Swal.fire('Updated!', '', 'success');
                } else {
                   Swal.fire('Error', res.message, 'error');
                }
            }).updateSupportItem(category, fullString, newValue, newType);
        }
    }

    // --- 3. TAMBAH BIASA (SIZE, STICKER, COVER) ---
    // SUDAH DIPERBAIKI (Typo Hilang & Auto Uppercase)
    function add(category) {
      const inputId = 'input-' + category;
      
      // PERBAIKAN: getElementById (bukan getElementByincludeId)
      let inputElement = document.getElementById(inputId); 
      let value = inputElement.value.trim();
      
      if(!value) {
          Swal.fire("Kosong", "Data tidak boleh kosong!", "warning");
          return;
      }

      // VALIDASI: Format standar jadi Uppercase biar rapi
      value = value.toUpperCase();

      inputElement.disabled = true;

      google.script.run.withSuccessHandler((res) => {
        inputElement.value = "";
        inputElement.disabled = false;
        
        if(res.success) {
            loadAllData();
            Swal.fire({ icon: 'success', title: 'Ditambahkan', toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 });
        } else {
            // Ini akan muncul jika DUPLIKAT (karena Code.gs sudah ada cek duplikat)
            Swal.fire("Gagal", res.message, "error"); 
        }
      }).addSupportItem(category, value, null);
    }

    function hapus(category, value) {
      Swal.fire({
        title: 'Hapus?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya'
      }).then((result) => {
        if (result.isConfirmed) {
           google.script.run.withSuccessHandler(() => loadAllData()).deleteSupportItem(category, value);
        }
      });
    }
  </script>
</body>
</html>
