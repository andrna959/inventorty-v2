<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* --- CORE VARIABLES --- */
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --border-color: #e2e8f0;
    }

    body { background-color: var(--bg-body); font-family: 'Inter', sans-serif; font-size: 13px; color: var(--text-main); }
    .content { margin-left: 250px; padding: 24px 32px; transition: all 0.3s; }

    /* --- HEADER & FILTER --- */
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .page-title { font-size: 20px; font-weight: 700; color: var(--text-main); margin: 0; }

    .filter-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .filter-label { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; display: block; }
    .form-control-sm { border-radius: 6px; border: 1px solid #cbd5e1; font-size: 13px; padding: 8px 12px; }
    .form-control-sm:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

    /* --- ACTION BAR --- */
    .action-bar { display: flex; justify-content: space-between; margin-bottom: 16px; }
    
    .btn-wms { font-weight: 600; font-size: 12px; padding: 8px 16px; border-radius: 6px; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; border: none; }
    .btn-primary-wms { background-color: var(--primary); color: white; }
    .btn-primary-wms:hover { background-color: var(--primary-hover); }
    .btn-light-wms { background-color: white; border: 1px solid #cbd5e1; color: var(--text-muted); }
    .btn-light-wms:hover { background-color: #f1f5f9; color: var(--text-main); }

    /* --- TABLE STYLING --- */
    .table-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
    
    /* Horizontal Scroll Wajib */
    .table-responsive { overflow-x: auto; white-space: nowrap; }
    
    .wms-table { width: 100%; border-collapse: collapse; }
    .wms-table thead { background-color: #f8fafc; border-bottom: 1px solid var(--border-color); }
    .wms-table th { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); padding: 14px 16px; text-align: left; }
    .wms-table td { padding: 12px 16px; border-bottom: 1px solid var(--border-color); vertical-align: middle; font-size: 13px; }
    .wms-table tr:hover { background-color: #f8fafc; }

    /* --- CUSTOM COMPONENTS --- */
    /* Status Badges */
    .badge-status { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .status-ok { background-color: #dcfce7; color: #15803d; }
    .status-near { background-color: #fef9c3; color: #a16207; }
    .status-exp { background-color: #fee2e2; color: #b91c1c; }
    .row-expired { background-color: #fff5f5 !important; }

    /* Attributes (Separated) */
    .attr-container { display: flex; flex-direction: column; gap: 2px; }
    .attr-line { font-size: 11px; color: var(--text-main); }
    .attr-lbl { font-weight: 700; color: #94a3b8; width: 24px; display: inline-block; font-size: 10px; }

    /* Notes Master */
    .notes-display { font-size: 11px; color: #64748b; font-style: italic; margin-top: 2px; max-width: 250px; white-space: normal; line-height: 1.3; }

    /* Qty */
    .qty-display { font-family: 'Inter', monospace; font-weight: 700; color: var(--primary); font-size: 14px; }

    /* --- MODAL DETAIL --- */
    .detail-group { margin-bottom: 16px; }
    .detail-label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; display: block; margin-bottom: 4px; }
    .detail-value { font-size: 14px; font-weight: 500; color: var(--text-main); display: block; }
    .notes-box { background: #f1f5f9; padding: 10px; border-radius: 6px; font-size: 12px; color: #475569; font-style: italic; border: 1px solid #e2e8f0; }
  </style>
</head>
<body>

  <?!= include('Sidebar', {scriptUrl: scriptUrl, page: page}); ?>

  <div class="content">
    
    <div class="page-header">
      <h1 class="page-title">Batch Product (Live Stock)</h1>
    </div>

    <div class="filter-card">
      <div class="row g-3">
        <div class="col-md-3">
          <span class="filter-label">Search (SKU/Name/Batch)</span>
          <input type="text" class="form-control form-control-sm" id="f-search" placeholder="Type keyword...">
        </div>
        <div class="col-md-2">
          <span class="filter-label">Location</span>
          <input type="text" class="form-control form-control-sm" id="f-loc" placeholder="EX.. / KL..">
        </div>
        <div class="col-md-2">
          <span class="filter-label">Brand</span>
          <input type="text" class="form-control form-control-sm" id="f-brand" placeholder="Brand...">
        </div>
        <div class="col-md-2">
          <span class="filter-label">Expired Range</span>
          <input type="date" class="form-control form-control-sm" id="f-exp">
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button class="btn-wms btn-primary-wms w-100 justify-content-center" onclick="applyFilter()">
            <i class="material-icons" style="font-size:18px">filter_alt</i> FILTER DATA
          </button>
        </div>
      </div>
    </div>

    <div class="action-bar">
      <div class="d-flex gap-2">
        <button class="btn-wms btn-light-wms" onclick="dummyInfo('Import')"><i class="material-icons" style="font-size:16px">upload_file</i> Import</button>
        <button class="btn-wms btn-light-wms" onclick="dummyInfo('Template')"><i class="material-icons" style="font-size:16px">description</i> Template</button>
        <button class="btn-wms btn-light-wms" onclick="dummyInfo('Add Manual')"><i class="material-icons" style="font-size:16px">add</i> Add</button>
      </div>
      <div>
        <button class="btn-wms btn-primary-wms" onclick="exportCSV()">
          <i class="material-icons" style="font-size:16px">download</i> EXPORT CSV
        </button>
      </div>
    </div>

    <div class="table-card">
      <div class="table-responsive">
        <table class="wms-table">
          <thead>
            <tr>
              <th style="min-width: 250px;">Product Info</th> <th style="min-width: 200px;">Notes (Master)</th>
              <th style="min-width: 150px;">Batch / Expired</th>
              <th style="min-width: 120px;">Location</th>
              <th style="min-width: 150px;">Attributes</th> <th style="min-width: 100px;">Status</th>
              <th style="min-width: 100px;" class="text-end">Qty</th>
              <th style="min-width: 80px;" class="text-center">Action</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="8" class="text-center py-5 text-muted">Memuat data stok...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">Detail Batch</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-4">
          
          <div class="row">
             <div class="col-12 detail-group">
                <span class="detail-label text-primary">Nama Produk</span>
                <span class="detail-value fs-5" id="d-nama">-</span>
             </div>
          </div>

          <div class="row">
             <div class="col-6 detail-group">
                <span class="detail-label">SKU</span>
                <span class="detail-value font-monospace" id="d-sku">-</span>
             </div>
             <div class="col-6 detail-group">
                <span class="detail-label">Brand</span>
                <span class="detail-value" id="d-brand">-</span>
             </div>
          </div>

          <div class="detail-group">
             <span class="detail-label text-danger">Notes (Master Produk)</span>
             <div class="notes-box" id="d-notes">-</div>
          </div>

          <div class="row border-top pt-3 mt-2">
             <div class="col-6 detail-group">
                <span class="detail-label">Batch Number</span>
                <span class="detail-value font-monospace" id="d-batch">-</span>
             </div>
             <div class="col-6 detail-group">
                <span class="detail-label">Expired Date</span>
                <span class="detail-value" id="d-exp">-</span>
             </div>
          </div>

          <div class="row">
             <div class="col-6 detail-group">
                <span class="detail-label">Lokasi</span>
                <span class="detail-value" id="d-loc">-</span>
             </div>
             <div class="col-6 detail-group">
                <span class="detail-label">Qty Current</span>
                <span class="detail-value text-primary fw-bold fs-5" id="d-qty">0</span>
             </div>
          </div>

          <div class="detail-group border-top pt-3">
             <span class="detail-label mb-2">Attributes</span>
             <div id="d-attr" class="text-muted small"></div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // GLOBAL VARIABLES
    let globalStockData = [];
    let masterProdukCache = []; // Cache untuk Notes dari Master
    let detailModalBS;

    document.addEventListener("DOMContentLoaded", function() {
       detailModalBS = new bootstrap.Modal(document.getElementById('detailModal'));
       
       // 1. Load Master Data DULU (untuk mendapatkan Notes)
       google.script.run.withSuccessHandler(data => {
          masterProdukCache = data; // Simpan: [Kode, Nama, Brand, Notes]
          
          // 2. Load Stock Data SETELAH Master siap
          loadStockData();
       }).getMasterData();
    });

    // --- LOAD DATA ---
    function loadStockData() {
       const tbody = document.getElementById('tableBody');
       tbody.innerHTML = '<tr><td colspan="8" class="text-center py-5"><div class="spinner-border text-primary spinner-border-sm"></div> Syncing Data...</td></tr>';

       google.script.run
         .withSuccessHandler(data => {
             globalStockData = data; 
             renderTable(data);
         })
         .withFailureHandler(err => {
             tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-5">Gagal memuat data: ${err.message}</td></tr>`;
         })
         .getBatchStockList('all'); // Backend function existing
    }

    // --- RENDER TABLE ---
    function renderTable(data) {
       const tbody = document.getElementById('tableBody');
       tbody.innerHTML = "";

       if (!data || data.length === 0) {
           tbody.innerHTML = '<tr><td colspan="8" class="text-center py-5 text-muted">Tidak ada stok aktif.</td></tr>';
           return;
       }

       data.forEach(row => {
          // A. LOGIC EXPIRED (Calculation)
          let statusHtml = `<span class="badge-status status-ok">OK</span>`;
          let rowClass = "";
          
          if(row.exp && row.exp !== "-") {
             let today = new Date();
             let expDate = new Date(row.exp);
             let diffTime = expDate - today;
             let days = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

             if(days < 0) { 
                 statusHtml = `<span class="badge-status status-exp">EXPIRED</span>`; 
                 rowClass = "row-expired";
             } else if(days < 90) { 
                 statusHtml = `<span class="badge-status status-near">NEAR EXP</span>`; 
             }
          }

          // B. ATTRIBUTES (Split 3 Baris)
          let attrHtml = `<div class="attr-container">`;
          if(row.sticker && row.sticker!=="-") attrHtml += `<span class="attr-line"><span class="attr-lbl">ST:</span> ${row.sticker}</span>`;
          if(row.size && row.size!=="-") attrHtml += `<span class="attr-line"><span class="attr-lbl">SZ:</span> ${row.size}</span>`;
          if(row.cover && row.cover!=="-") attrHtml += `<span class="attr-line"><span class="attr-lbl">CV:</span> ${row.cover}</span>`;
          attrHtml += `</div>`;
          
          if(attrHtml === `<div class="attr-container"></div>`) attrHtml = "-";

          // C. NOTES MASTER (Lookup)
          let masterItem = masterProdukCache.find(m => String(m[0]) === String(row.kode));
          let masterNotes = (masterItem && masterItem[3]) ? masterItem[3] : "-";

          // BUILD ROW
          let tr = document.createElement('tr');
          if(rowClass) tr.className = rowClass;
          
          tr.innerHTML = `
            <td>
               <div class="fw-bold text-primary font-monospace">${row.kode}</div>
               <div class="fw-bold text-dark">${row.nama}</div>
               <div class="small text-muted">${row.brand || '-'}</div>
            </td>
            <td>
               <div class="notes-display"><i class="material-icons" style="font-size:10px">info</i> ${masterNotes}</div>
            </td>
            <td>
               <div class="fw-bold small font-monospace">${row.batch || '-'}</div>
               <div class="small text-muted">${row.exp || '-'}</div>
            </td>
            <td>
                <div class="fw-bold text-dark">${row.lokasi}</div>
                <div class="small text-muted" style="font-size:10px">${row.typeLoc}</div>
            </td>
            <td>${attrHtml}</td>
            <td>${statusHtml}</td>
            <td class="text-end qty-display">${row.qty}</td>
            <td class="text-center">
               <button class="btn btn-sm btn-light border" onclick='showDetail(${JSON.stringify(row)})'>
                 <i class="material-icons" style="font-size:16px; color:#64748b">visibility</i>
               </button>
            </td>
          `;
          tbody.appendChild(tr);
       });
    }

    // --- POPUP DETAIL ---
    function showDetail(item) {
       // Lookup Notes Master lagi untuk Detail
       let masterItem = masterProdukCache.find(m => String(m[0]) === String(item.kode));
       let masterNotes = (masterItem && masterItem[3]) ? masterItem[3] : "-";

       document.getElementById('d-nama').innerText = item.nama;
       document.getElementById('d-sku').innerText = item.kode;
       document.getElementById('d-brand').innerText = item.brand;
       document.getElementById('d-notes').innerText = masterNotes; // Display Notes
       document.getElementById('d-batch').innerText = item.batch;
       document.getElementById('d-exp').innerText = item.exp;
       document.getElementById('d-loc').innerHTML = `<span class="badge bg-light text-dark border">${item.typeLoc}</span> <b>${item.lokasi}</b>`;
       document.getElementById('d-qty').innerText = item.qty;

       // Render Atribut Detail
       let attrHtml = "";
       if(item.sticker && item.sticker!=="-") attrHtml += `<div><b>ST:</b> ${item.sticker}</div>`;
       if(item.size && item.size!=="-") attrHtml += `<div><b>SZ:</b> ${item.size}</div>`;
       if(item.cover && item.cover!=="-") attrHtml += `<div><b>CV:</b> ${item.cover}</div>`;
       if(attrHtml==="") attrHtml = "Tidak ada atribut.";
       
       document.getElementById('d-attr').innerHTML = attrHtml;

       detailModalBS.show();
    }

    // --- FILTER LOGIC ---
    function applyFilter() {
       const search = document.getElementById('f-search').value.toLowerCase();
       const loc = document.getElementById('f-loc').value.toLowerCase();
       const brand = document.getElementById('f-brand').value.toLowerCase();
       const expDate = document.getElementById('f-exp').value;

       const filtered = globalStockData.filter(item => {
          let match = true;
          // Search All
          if(search && !String(item.kode).toLowerCase().includes(search) && 
             !String(item.nama).toLowerCase().includes(search) && 
             !String(item.batch).toLowerCase().includes(search)) match = false;
          
          if(loc && !String(item.lokasi).toLowerCase().includes(loc)) match = false;
          if(brand && !String(item.brand).toLowerCase().includes(brand)) match = false;
          
          if(expDate && item.exp) {
             if(item.exp === "-") match = false;
             else if(new Date(item.exp) > new Date(expDate)) match = false; // Filter: Tampilkan yang Expired sebelum tanggal ini
          }
          return match;
       });
       renderTable(filtered);
    }

    // --- EXPORT CSV (FORMAT WAJIB) ---
    function exportCSV() {
       if(!globalStockData || globalStockData.length === 0) {
          Swal.fire("Data Kosong", "Tidak ada data untuk diexport.", "warning");
          return;
       }

       // Header Wajib
       let csvContent = "SKU,Name,Brand,Notes,Batch,Expired,Location,Sticker,Size,Cover,Qty,Status\n";

       globalStockData.forEach(row => {
          // 1. Ambil Notes
          let masterItem = masterProdukCache.find(m => String(m[0]) === String(row.kode));
          let masterNotes = (masterItem && masterItem[3]) ? masterItem[3].replace(/,/g, " ") : "-";

          // 2. Hitung Status Text
          let statusText = "OK";
          if(row.exp && row.exp !== "-") {
             let days = Math.ceil((new Date(row.exp) - new Date()) / (1000 * 60 * 60 * 24));
             if(days < 0) statusText = "EXPIRED";
             else if(days < 90) statusText = "NEAR";
          }

          // 3. Bersihkan Koma (agar CSV aman)
          const clean = (txt) => String(txt || "").replace(/,/g, " ");

          csvContent += [
             clean(row.kode),
             clean(row.nama),
             clean(row.brand),
             masterNotes,
             clean(row.batch),
             clean(row.exp),
             clean(row.lokasi),
             clean(row.sticker || "-"), // Sticker
             clean(row.size || "-"),    // Size
             clean(row.cover || "-"),   // Cover
             row.qty,
             statusText
          ].join(",") + "\n";
       });

       // Download
       const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8" });
       const url = URL.createObjectURL(blob);
       const a = document.createElement("a");
       a.href = url;
       a.download = `Stock_Export_${new Date().toISOString().slice(0,10)}.csv`;
       document.body.appendChild(a);
       a.click();
       document.body.removeChild(a);
    }

    function dummyInfo(txt) { Swal.fire(txt, "Fitur ini tersedia.", "info"); }
  </script>
</body>
</html>
