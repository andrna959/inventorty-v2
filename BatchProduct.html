<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* --- 1. CORE VARIABLES & RESET --- */
    :root {
      --primary-purple: #5e50ee; /* Warna Ungu Tombol Search/Export */
      --primary-purple-hover: #4b3ecf;
      --soft-blue: #e0e7ff;
      --text-dark: #1f2937;
      --text-gray: #6b7280;
      --bg-body: #f9fafb;
      --border-color: #e5e7eb;
    }
    
    body { background-color: var(--bg-body); font-family: 'Inter', sans-serif; font-size: 13px; color: var(--text-dark); }
    .content { margin-left: 250px; padding: 25px 40px; transition: all 0.3s; }
    
    /* --- 2. HEADER & TITLE --- */
    .page-header { margin-bottom: 20px; }
    .page-title { font-size: 20px; font-weight: 700; color: #111827; margin: 0; }
    
    /* --- 3. FILTER SECTION (RED BOX REFERENCE) --- */
    .filter-card {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    
    .filter-header {
      display: flex; align-items: center; gap: 8px;
      font-weight: 600; color: var(--primary-purple); margin-bottom: 15px;
      cursor: pointer;
    }
    
    .form-label-custom {
      font-size: 11px; font-weight: 600; color: var(--text-gray); margin-bottom: 4px; display: block;
    }
    
    .form-control-custom, .form-select-custom {
      border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; padding: 8px 12px; width: 100%; transition: 0.2s;
    }
    .form-control-custom:focus { border-color: var(--primary-purple); outline: none; box-shadow: 0 0 0 2px rgba(94, 80, 238, 0.1); }

    /* Switch Toggle */
    .form-check-input:checked { background-color: var(--primary-purple); border-color: var(--primary-purple); }
    
    /* Buttons */
    .btn-custom { font-weight: 600; font-size: 12px; padding: 8px 16px; border-radius: 6px; border: none; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .btn-purple { background-color: var(--primary-purple); color: white; }
    .btn-purple:hover { background-color: var(--primary-purple-hover); color: white; }
    
    .btn-white { background-color: white; border: 1px solid #d1d5db; color: var(--text-gray); }
    .btn-white:hover { background-color: #f3f4f6; color: var(--text-dark); }
    
    .btn-blue-light { background-color: #38bdf8; color: white; } /* Import Button */
    .btn-blue-light:hover { background-color: #0ea5e9; color: white; }

    /* Text Links */
    .text-action-link { color: #818cf8; font-weight: 600; text-decoration: none; font-size: 12px; margin-left: 15px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; }
    .text-action-link:hover { color: var(--primary-purple); text-decoration: underline; }

    /* --- 4. ACTION BAR (IMPORT/EXPORT) --- */
    .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    
    /* --- 5. TABLE STYLES (MODERN CLEAN) --- */
    .table-container { background: white; border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden; }
    .table-custom { width: 100%; border-collapse: collapse; }
    
    .table-custom thead { background-color: #f9fafb; border-bottom: 1px solid var(--border-color); }
    .table-custom th {
      text-align: left; font-size: 11px; font-weight: 700; color: var(--text-gray); 
      text-transform: uppercase; padding: 12px 16px; letter-spacing: 0.5px;
    }
    
    .table-custom td {
      padding: 12px 16px; border-bottom: 1px solid #f3f4f6; font-size: 13px; color: var(--text-dark); vertical-align: middle;
    }
    .table-custom tr:last-child td { border-bottom: none; }
    .table-custom tr:hover { background-color: #f8fafc; }

    /* Reference Column (Icon + SKU) */
    .ref-col { display: flex; align-items: center; gap: 8px; font-weight: 600; color: var(--primary-purple); }
    .ref-icon { color: #9ca3af; font-size: 16px; cursor: pointer; }
    .ref-icon:hover { color: var(--primary-purple); }

    /* Status Badges */
    .badge-status { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .badge-ok { background-color: #dcfce7; color: #166534; } /* Sellable */
    .badge-near { background-color: #fef9c3; color: #854d0e; } /* Interim */
    .badge-exp { background-color: #fee2e2; color: #991b1b; } /* Expired */

    /* Qty Column */
    .qty-col { display: flex; align-items: center; justify-content: flex-end; gap: 6px; font-weight: 700; }
    .eye-icon { font-size: 16px; color: #a5b4fc; cursor: pointer; }
  </style>
</head>
<body>

  <?!= include('Sidebar', {scriptUrl: scriptUrl, page: page}); ?>

  <div class="content">
    
    <div class="page-header">
      <h1 class="page-title">Batch Product</h1>
    </div>

    <div class="filter-card">
      <div class="filter-header" onclick="toggleFilter()">
        <i class="material-icons">search</i> Filter
      </div>
      
      <div id="filterContent">
        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <span class="form-label-custom">SKU / REFERENCE</span>
            <input type="text" class="form-control-custom" id="f-sku" placeholder="Search SKU...">
          </div>
          <div class="col-md-3">
            <span class="form-label-custom">NAME</span>
            <input type="text" class="form-control-custom" id="f-name" placeholder="Search Product Name...">
          </div>
          <div class="col-md-3">
            <span class="form-label-custom">BRAND</span>
            <input type="text" class="form-control-custom" id="f-brand" placeholder="Search Brand...">
          </div>
          <div class="col-md-3">
            <span class="form-label-custom">LOCATION</span>
            <input type="text" class="form-control-custom" id="f-loc" placeholder="Search Location...">
          </div>
        </div>

        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <span class="form-label-custom">TYPE / ATTRIBUTE</span>
            <input type="text" class="form-control-custom" id="f-type" placeholder="Ex: Size, Sticker...">
          </div>
          <div class="col-md-3">
             <span class="form-label-custom">EXPIRED DATE (FROM)</span>
             <input type="date" class="form-control-custom" id="f-exp-from">
          </div>
          <div class="col-md-3">
             <span class="form-label-custom">EXPIRED DATE (TO)</span>
             <input type="date" class="form-control-custom" id="f-exp-to">
          </div>
          <div class="col-md-3 text-end">
             <div class="d-flex justify-content-end gap-2">
               <button class="btn-custom btn-purple" onclick="applyCustomFilter()">SEARCH</button>
               <button class="btn-custom btn-white" onclick="resetFilter()">RESET</button>
             </div>
          </div>
        </div>
      </div>
      
      <div class="mt-3 d-flex align-items-center">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="alwaysOpen" checked>
          <label class="form-check-label small text-muted" for="alwaysOpen">Always open</label>
        </div>
      </div>
    </div>

    <div class="action-bar">
      <div class="d-flex align-items-center">
        <button class="btn-custom btn-blue-light shadow-sm" onclick="showImportModal()">
          <i class="material-icons" style="font-size:16px">cloud_upload</i> IMPORT FROM EXCEL
        </button>
        <span class="text-action-link" onclick="downloadTemplate()"><i class="material-icons" style="font-size:16px">download</i> FILE TEMPLATE</span>
        <span class="text-action-link" onclick="showAddModal()"><i class="material-icons" style="font-size:16px">add</i> ADD</span>
      </div>
      
      <div class="d-flex gap-2">
        <button class="btn-custom btn-purple shadow-sm" onclick="exportData('branch')">EXPORT ALL BRANCH</button>
        <button class="btn-custom btn-purple shadow-sm" onclick="exportData('csv')">EXPORT CSV</button>
      </div>
    </div>

    <div class="table-container">
      <div class="table-responsive">
        <table class="table-custom">
          <thead>
            <tr>
              <th width="15%">Reference</th>
              <th width="20%">Name</th>
              <th width="10%">Brand</th>
              <th width="10%">Expired Date</th>
              <th width="10%">Box / Location</th>
              <th width="15%">Type / Attr</th>
              <th width="5%">Status</th>
              <th width="10%">Batch No</th>
              <th width="5%" class="text-end">Qty</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="9" class="text-center p-5 text-muted">Initializing data...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let globalStockData = [];

    document.addEventListener("DOMContentLoaded", function() {
       loadStockData();
    });

    // --- 1. DATA LOADING (LOGIC TETAP SAMA) ---
    function loadStockData() {
       document.getElementById('tableBody').innerHTML = '<tr><td colspan="9" class="text-center p-5"><div class="spinner-border text-primary spinner-border-sm"></div> Loading Live Stock...</td></tr>';

       google.script.run
         .withSuccessHandler(data => {
             globalStockData = data; // Simpan di memori untuk client-side filtering
             renderTable(data);
         })
         .withFailureHandler(err => {
             document.getElementById('tableBody').innerHTML = `<tr><td colspan="9" class="text-center text-danger p-5">Failed to load: ${err.message}</td></tr>`;
         })
         .getBatchStockList('all'); // Panggil fungsi backend existing
    }

    // --- 2. RENDERING TABEL (SESUAI DESAIN MERAH) ---
    function renderTable(data) {
       const tbody = document.getElementById('tableBody');
       tbody.innerHTML = "";

       if (!data || data.length === 0) {
           tbody.innerHTML = '<tr><td colspan="9" class="text-center p-5 text-muted">No data found matching your criteria.</td></tr>';
           return;
       }

       data.forEach(row => {
          // Logic Status (Sesuai Logic Existing: Expired calculation)
          let statusBadge = `<span class="badge-status badge-ok">Sellable</span>`; // Default OK
          let rowClass = "";
          
          if(row.exp && row.exp !== "-") {
             let days = Math.ceil((new Date(row.exp) - new Date()) / (1000 * 60 * 60 * 24));
             if(days < 0) { 
                 statusBadge = `<span class="badge-status badge-exp">Expired</span>`; 
             } else if(days < 90) { 
                 statusBadge = `<span class="badge-status badge-near">Interim</span>`; 
             }
          } else {
             // Jika tidak ada expired date, anggap OK/Sellable (Logic existing)
             statusBadge = `<span class="badge-status badge-ok">Sellable</span>`;
          }

          // Atribut Join
          let attr = [];
          if(row.size && row.size!=="-") attr.push(row.size);
          if(row.sticker && row.sticker!=="-") attr.push(row.sticker);
          if(row.cover && row.cover!=="-") attr.push(row.cover);
          let attrString = attr.length > 0 ? attr.join(", ") : "-";

          let tr = document.createElement('tr');
          tr.innerHTML = `
            <td>
              <div class="ref-col">
                <i class="material-icons ref-icon" title="Print">print</i>
                <i class="material-icons ref-icon" title="View File">description</i>
                <span class="text-primary">${row.kode}</span>
              </div>
            </td>
            <td class="fw-bold">${row.nama}</td>
            <td>${row.brand || '-'}</td>
            <td>${row.exp || '-'}</td>
            <td>
                <div class="fw-bold text-dark">${row.lokasi}</div>
                <div class="small text-muted" style="font-size:10px">${row.typeLoc}</div>
            </td>
            <td class="text-muted small">${attrString}</td>
            <td>${statusBadge}</td>
            <td class="font-monospace small text-dark fw-bold">${row.batch || '-'}</td>
            <td>
               <div class="qty-col">
                 <i class="material-icons eye-icon">visibility</i>
                 <span>${row.qty}</span>
               </div>
            </td>
          `;
          tbody.appendChild(tr);
       });
    }

    // --- 3. CLIENT SIDE FILTERING (PENGGANTI DATATABLES SEARCH) ---
    function applyCustomFilter() {
        const sku = document.getElementById('f-sku').value.toLowerCase();
        const name = document.getElementById('f-name').value.toLowerCase();
        const brand = document.getElementById('f-brand').value.toLowerCase();
        const loc = document.getElementById('f-loc').value.toLowerCase();
        const type = document.getElementById('f-type').value.toLowerCase();
        
        // Date Range Logic
        const dateFrom = document.getElementById('f-exp-from').value;
        const dateTo = document.getElementById('f-exp-to').value;

        const filtered = globalStockData.filter(item => {
            let match = true;
            
            if(sku && !String(item.kode).toLowerCase().includes(sku)) match = false;
            if(match && name && !String(item.nama).toLowerCase().includes(name)) match = false;
            if(match && brand && !String(item.brand).toLowerCase().includes(brand)) match = false;
            if(match && loc && !String(item.lokasi).toLowerCase().includes(loc)) match = false;
            
            // Check Attributes (Type)
            if(match && type) {
               const combinedAttr = (item.size + item.sticker + item.cover).toLowerCase();
               if(!combinedAttr.includes(type)) match = false;
            }

            // Check Date Range (If set)
            if(match && (dateFrom || dateTo)) {
                if(item.exp === "-" || !item.exp) {
                    match = false; // Exclude non-exp items if filtering by date
                } else {
                    const itemDate = new Date(item.exp);
                    if(dateFrom && itemDate < new Date(dateFrom)) match = false;
                    if(dateTo && itemDate > new Date(dateTo)) match = false;
                }
            }

            return match;
        });

        renderTable(filtered);
    }

    function resetFilter() {
        document.getElementById('f-sku').value = "";
        document.getElementById('f-name').value = "";
        document.getElementById('f-brand').value = "";
        document.getElementById('f-loc').value = "";
        document.getElementById('f-type').value = "";
        document.getElementById('f-exp-from').value = "";
        document.getElementById('f-exp-to').value = "";
        renderTable(globalStockData);
    }

    function toggleFilter() {
        // Optional: Implement collapse logic if needed, but "Always open" toggle implies visibility
    }

    // --- 4. DUMMY ACTIONS (UI ONLY) ---
    function showImportModal() { Swal.fire("Import", "Fitur Import Excel", "info"); }
    function downloadTemplate() { Swal.fire("Template", "Download Template", "success"); }
    function showAddModal() { Swal.fire("Add", "Tambah Manual", "info"); }
    function exportData(type) { Swal.fire("Export", "Export type: " + type, "success"); }

  </script>
</body>
</html>
